<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | Sejuk Teknik AC</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* --- VARIABEL & RESET DASAR --- */
      :root {
        --primary: #0066cc;
        --primary-light: #e6f2ff;
        --secondary: #ff7a00;
        --dark: #2d3748;
        --light: #f8fafc;
        --gray: #718096;
        --white: #ffffff;
        --coin: #ffd700;
        --success: #4caf50;
        --danger: #f44336;
        --sidebar-width: 250px;
        --header-height: 70px;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Poppins", sans-serif;
        color: var(--dark);
        line-height: 1.6;
        background-color: var(--light);
        min-height: 100vh;
      }
      
      /* --- LAYOUT DASHBOARD --- */
      .dashboard-container {
        display: flex;
        min-height: 100vh;
      }
      
      /* Sidebar */
      .sidebar {
        width: var(--sidebar-width);
        background-color: var(--dark);
        color: var(--white);
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        transition: all 0.3s ease;
        z-index: 1000;
      }
      
      .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .sidebar-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .sidebar-menu {
        padding: 1rem 0;
      }
      
      .menu-item {
        display: block;
        padding: 0.8rem 1.5rem;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s ease;
        position: relative;
        border-left: 3px solid transparent;
      }
      
      .menu-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--white);
      }
      
      .menu-item.active {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--white);
        border-left: 3px solid var(--secondary);
      }
      
      .menu-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }
      
      .sidebar-footer {
        position: absolute;
        bottom: 0;
        width: 100%;
        padding: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: var(--sidebar-width);
        transition: all 0.3s ease;
      }
      
      /* Header */
      .header {
        background-color: var(--white);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        height: var(--header-height);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 2rem;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .header-left h1 {
        font-size: 1.5rem;
        color: var(--dark);
      }
      
      .header-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      
      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-weight: 600;
      }
      
      .user-details p {
        font-size: 0.9rem;
        margin: 0;
      }
      
      .user-details .user-role {
        font-size: 0.75rem;
        color: var(--gray);
      }
      
      .logout-btn {
        background-color: var(--danger);
        color: var(--white);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      
      .logout-btn:hover {
        background-color: #d32f2f;
      }
      
      /* Content Area */
      .content {
        padding: 2rem;
      }
      
      /* Dashboard Overview */
      .dashboard-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }
      
      .stat-card {
        background-color: var(--white);
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        transition: transform 0.3s ease;
      }
      
      .stat-card:hover {
        transform: translateY(-5px);
      }
      
      .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1rem;
      }
      
      .stat-icon.primary {
        background-color: var(--primary-light);
        color: var(--primary);
      }
      
      .stat-icon.success {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--success);
      }
      
      .stat-icon.warning {
        background-color: rgba(255, 152, 0, 0.1);
        color: var(--secondary);
      }
      
      .stat-icon.danger {
        background-color: rgba(244, 67, 54, 0.1);
        color: var(--danger);
      }
      
      .stat-info h3 {
        font-size: 1.8rem;
        margin-bottom: 0.2rem;
      }
      
      .stat-info p {
        color: var(--gray);
        font-size: 0.9rem;
      }
      
      /* Charts Section */
      .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }
      
      .chart-container {
        background-color: var(--white);
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      
      .chart-header h3 {
        font-size: 1.2rem;
        color: var(--dark);
      }
      
      .chart-options {
        display: flex;
        gap: 0.5rem;
      }
      
      .chart-option {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .chart-option.active {
        background-color: var(--primary-light);
        color: var(--primary);
      }
      
      /* General Content Card Styles (Reusable) */
      .card {
        background: var(--white);
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
      }
      
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      
      .card-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--dark);
      }

      /* Form & Input Styles */
      .form-group {
        margin-bottom: 1rem;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }
      
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-family: "Poppins", sans-serif;
      }
      
      .btn {
        display: inline-block;
        background-color: var(--primary);
        color: var(--white);
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        border: 2px solid var(--primary);
        cursor: pointer;
        text-align: center;
      }
      
      .btn:hover {
        background-color: transparent;
        color: var(--primary);
      }
      
      .btn-danger {
        background-color: var(--danger);
        border-color: var(--danger);
      }
      
      .btn-danger:hover {
        color: var(--danger);
        background-color: transparent;
      }
      
      .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
      }
      
      /* Modal Styles (General) */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      
      .modal-content {
        background: var(--white);
        padding: 1.5rem;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      
      .modal-content h3 {
        margin-bottom: 1rem;
        color: var(--primary);
      }
      
      .modal-content textarea {
        width: 100%;
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-bottom: 1rem;
        resize: vertical;
      }
      
      .modal-content .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-weight: bold;
        border: none;
        background: transparent;
        font-size: 1.2rem;
      }
      
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      /* Review List Styles */
      .review-card {
        background: var(--light);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 5px solid var(--primary);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      .review-stars i { color: #ffc107; }
      /* User Search & Table Styles */
      .notification-list-target { 
          max-height: 400px; 
          overflow-y: auto;
          border: 1px solid #eee;
          border-radius: 8px;
          padding: 10px;
          background: var(--white);
      }
      .user-list-item {
          padding: 8px;
          border-bottom: 1px dashed #eee;
          cursor: pointer;
          transition: background-color 0.2s;
          line-height: 1.2;
      }
      .user-list-item:hover { background-color: var(--primary-light); }
      .user-detail-list strong { display: inline-block; width: 120px; color: var(--primary); }
      .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }

      /* System Status Section */
      .status-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
      }
      .status-card {
        text-align: center;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      .status-open { background-color: var(--success); color: var(--white); }
      .status-closed { background-color: var(--danger); color: var(--white); }
      .status-label { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; }
      .status-time { font-size: 1.2rem; margin-bottom: 1rem; }
      
      /* Chart Fix untuk tampilan vertikal panjang */
      #ordersChart, #reviewsChart {
          max-height: 300px; 
          min-height: 250px;
      }

    </style>
  </head>
  <body>
    <!-- Generic Alert Modal (Untuk feedback) -->
    <div id="genericAlertModal" class="modal-overlay">
      <div class="modal-content">
        <div class="confirm-title" id="alertTitle"></div>
        <div class="confirm-message" id="alertMessage"></div>
        <div class="modal-footer">
          <button class="btn confirm-yes" id="alertCloseBtn">
            Oke, Lanjut! üëç
          </button>
        </div>
      </div>
    </div>

    <!-- Modal for Admin Reply -->
    <div class="modal-overlay" id="replyModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeReplyModal()">√ó</button>
        <h3 id="replyModalTitle">Boss mau bales apa ke <span id="replyReviewerName"></span>?</h3>
        <textarea id="replyTextarea" rows="5" placeholder="Tulis balasan..."></textarea>
        <div class="modal-footer">
            <button class="btn" style="background-color: var(--gray);" onclick="closeReplyModal()">Batal</button>
            <button class="btn" id="sendReplyBtn">Kirim Balasan</button>
        </div>
      </div>
    </div>
    
    <!-- Modal for User Details -->
    <div class="modal-overlay" id="userDetailModal">
      <div class="modal-content" style="max-width: 550px;">
        <button class="close-btn" onclick="closeUserDetailModal()">√ó</button>
        <h3 id="userDetailTitle">Detail Pengguna: Loading...</h3>
        <div id="userDetailContent" class="user-detail-list">
           <p><strong>Nama:</strong> <span id="detailName"></span></p>
           <p><strong>Email:</strong> <span id="detailEmail"></span></p>
           <p><strong>Alamat:</strong> <span id="detailAddress"></span></p>
           <p><strong>No. HP:</strong> <span id="detailPhone"></span></p>
           <p><strong>SJCoin:</strong> <span id="detailSJCoin" style="color: var(--coin); font-weight: 600;"></span></p>
           <p><strong>Bergabung:</strong> <span id="detailJoined"></span></p>
           <p><strong>UID:</strong> <span id="detailUID" style="font-size: 0.9em;"></span></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="deleteUser()">Hapus User</button>
        </div>
      </div>
    </div>

    <!-- NEW: Modal for Add New Review -->
    <div class="modal-overlay" id="addReviewModal">
      <div class="modal-content" style="max-width: 550px;">
        <button class="close-btn" onclick="closeAddReviewModal()">√ó</button>
        <h3><i class="fas fa-map-marked-alt"></i> Tambah Ulasan Google Maps</h3>
        <form id="addReviewForm">
            <div class="form-group">
                <label for="newReviewerName">Nama Pemberi Ulasan</label>
                <input type="text" id="newReviewerName" required placeholder="Contoh: Asep Kipas">
            </div>
            <div class="form-group">
                <label for="newReviewRating">Rating (1-5 Bintang)</label>
                <select id="newReviewRating" required>
                    <option value="5">5 Bintang</option>
                    <option value="4">4 Bintang</option>
                    <option value="3">3 Bintang</option>
                    <option value="2">2 Bintang</option>
                    <option value="1">1 Bintang</option>
                </select>
            </div>
            <div class="form-group">
                <label for="newReviewText">Isi Pesan Ulasan</label>
                <textarea id="newReviewText" rows="4" required placeholder="Tulis ulasan pelanggan..."></textarea>
            </div>
            <div class="form-group">
                <label for="newReviewTimestamp">Waktu Ulasan (Untuk Tampilan 'X tahun lalu')</label>
                <!-- Menggunakan datetime-local untuk input waktu spesifik -->
                <input type="datetime-local" id="newReviewTimestamp" required>
                <p style="font-size: 0.8em; color: var(--gray); margin-top: 5px;">Pilih waktu masa lampau untuk mendapatkan tampilan 'X tahun lalu'. Waktu masa depan akan menampilkan 'X tahun dari sekarang'.</p>
            </div>
            <div class="modal-footer">
                <button class="btn" type="button" style="background-color: var(--gray);" onclick="closeAddReviewModal()">Batal</button>
                <button class="btn" type="submit" id="saveNewReviewBtn">Simpan Ulasan Baru</button>
            </div>
        </form>
      </div>
    </div>

    <div class="dashboard-container">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2><i class="fas fa-snowflake"></i> Sejuk Teknik</h2>
        </div>
        <div class="sidebar-menu">
          <a href="#" class="menu-item active" data-page="dashboard">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </a>
          <a href="#" class="menu-item" data-page="reviews">
            <i class="fas fa-star"></i> Kelola Ulasan
          </a>
          <a href="#" class="menu-item" data-page="notif">
            <i class="fas fa-bullhorn"></i> Kirim Notifikasi
          </a>
          <a href="#" class="menu-item" data-page="events">
            <i class="fas fa-calendar-alt"></i> Event Pop-up
          </a>
          <a href="#" class="menu-item" data-page="orders">
            <i class="fas fa-shopping-cart"></i> Kelola Pesanan
          </a>
          <a href="#" class="menu-item" data-page="users">
            <i class="fas fa-users"></i> User List
          </a>
          <a href="#" class="menu-item" data-page="sistem">
            <i class="fas fa-cog"></i> Sistem (Buka/Tutup)
          </a>
        </div>
        <div class="sidebar-footer">
          <button class="logout-btn" id="logoutBtn" style="width: 100%;">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <header class="header">
          <div class="header-left">
            <button class="mobile-menu-toggle" id="mobileMenuToggle">
              <i class="fas fa-bars"></i>
            </button>
            <h1 id="pageTitle">Dashboard</h1>
          </div>
          <div class="header-right">
            <div class="user-info">
              <div class="user-avatar" id="userAvatar">A</div>
              <div class="user-details">
                <p id="userName">Admin</p>
                <p class="user-role">Administrator</p>
              </div>
            </div>
          </div>
        </header>

        <!-- Content Area -->
        <div class="content">
          <!-- Dashboard Overview -->
          <div id="dashboardPage" class="page-content">
            <!-- Tempat tombol inisialisasi -->
            <div class="card" id="settingsInitCard" style="display: none; background-color: var(--danger); color: var(--white); text-align: center;">
                <p style="font-weight: 600; margin-bottom: 10px;">‚ö†Ô∏è PERHATIAN: Koleksi Pengaturan Sistem Belum Ada!</p>
                <button class="btn" onclick="initializeDefaultSettings()" style="background-color: var(--white); color: var(--danger); border-color: var(--white);">
                    <i class="fas fa-cogs"></i> KLIK UNTUK INISIALISASI SETTINGS!
                </button>
            </div>
            
            <div class="dashboard-overview">
              <div class="stat-card">
                <div class="stat-icon primary">
                  <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                  <h3 id="totalUsers">0</h3>
                  <p>Total Pengguna</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon success">
                  <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-info">
                  <h3 id="totalOrders">0</h3>
                  <p>Total Pesanan</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon warning">
                  <i class="fas fa-star"></i>
                </div>
                <div class="stat-info">
                  <h3 id="totalReviews">0</h3>
                  <p>Total Ulasan</p>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon danger">
                  <i class="fas fa-coins"></i>
                </div>
                <div class="stat-info">
                  <h3 id="totalCoins">0</h3>
                  <p>Total SJCoin</p>
                </div>
              </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
              <div class="chart-container">
                <div class="chart-header">
                  <h3>Statistik Pesanan</h3>
                  <div class="chart-options">
                    <span class="chart-option active">Minggu</span>
                    <span class="chart-option">Bulan</span>
                    <span class="chart-option">Tahun</span>
                  </div>
                </div>
                <!-- Menambahkan tinggi tetap untuk mengatasi bug chart memanjang -->
                <canvas id="ordersChart" height="300"></canvas>
              </div>
              <div class="chart-container">
                <div class="chart-header">
                  <h3>Distribusi Ulasan</h3>
                  <div class="chart-options">
                    <span class="chart-option active">Rating</span>
                  </div>
                </div>
                <!-- Menambahkan tinggi tetap untuk mengatasi bug chart memanjang -->
                <canvas id="reviewsChart" height="300"></canvas>
              </div>
            </div>

            <!-- Recent Activities -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Aktivitas Terbaru</h3>
              </div>
              <div id="recentActivities">
                <p style="text-align:center;">Memuat aktivitas terbaru...</p>
              </div>
            </div>
          </div>

          <!-- Tab Konten: Kelola Ulasan -->
          <div id="reviewsPage" class="page-content" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Daftar Ulasan Pelanggan</h3>
                <!-- NEW BUTTON HERE -->
                <button class="btn" onclick="openAddReviewModal()">
                  <i class="fas fa-plus"></i> Tambahkan Ulasan
                </button>
                <!-- END NEW BUTTON -->
              </div>
              <div id="reviewsList">
                <p style="text-align:center;">Memuat ulasan...</p>
              </div>
            </div>
          </div>
          
          <!-- Tab Konten: Kirim Notifikasi -->
          <div id="notifPage" class="page-content" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Kirim Pesan ke User</h3>
              </div>
              <p>Pilih user yang akan menerima notifikasi. Ketik 'ALL' untuk broadcast.</p>
              
              <div id="userSearchArea" class="form-group">
                <input type="text" id="userSearch" placeholder="Cari User (Nama/Email) atau ketik ALL">
                <div id="userSearchResults" class="notification-list-target" style="margin-top: 10px; display: none;">
                  <!-- Hasil pencarian user -->
                </div>
                <p id="selectedUser" style="margin-top: 10px; font-weight: 600; color: var(--success); display: none;">
                  ‚úÖ Target: <span id="selectedUserName"></span> 
                  <span id="selectedUserUID" style="font-size: 0.8em; color: var(--gray);"></span>
                </p>
              </div>
              
              <div class="form-group">
                <label for="notifTitleSelect">Saran Judul</label>
                <select id="notifTitleSelect">
                  <option value="CUSTOM">-- Judul Kustom --</option>
                  <!-- PENAMBAHAN SARAN JUDUL BARU -->
                  <option value="Transaksi Berhasil!">Transaksi Berhasil!</option>
                  <option value="Promo Spesial Hari Ini!">Promo Spesial Hari Ini!</option>
                  <option value="Hadiah dari Sistem!">Hadiah dari Sistem!</option>
                  <option value="Perubahan Kebijakan">Perubahan Kebijakan</option>
                  <option value="Peringatan Akun">Peringatan Akun</option>
                  <option value="Selamat Bergabung!">Selamat Bergabung!</option>
                  <option value="Hadiah Klaim Koin!">Hadiah Klaim Koin!</option>
                  <option value="Update Status Pesanan!">Update Status Pesanan!</option>
                  <option value="Promosi Terbaru!">Promosi Terbaru!</option>
                </select>
              </div>

              <form id="notificationForm" style="margin-top: 15px;">
                <div class="form-group">
                  <label for="notifTitle">Judul Notifikasi</label>
                  <input type="text" id="notifTitle" required>
                </div>
                <div class="form-group">
                  <label for="notifContent">Isi Pesan</label>
                  <textarea id="notifContent" rows="3" required></textarea>
                </div>
                <div class="form-group">
                  <label for="coinReward">Hadiah SJCoin (Opsional)</label>
                  <input type="number" id="coinReward" min="0" value="0">
                </div>
                <button type="submit" class="btn" id="sendNotifBtn">Kirim Notifikasi</button>
              </form>
            </div>
          </div>

          <!-- Tab Konten: Event Pop-up -->
          <div id="eventsPage" class="page-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Event Pop-up Global</h3>
                </div>
                
                <form id="eventForm">
                    <div class="form-group">
                        <label for="eventTitle">Judul Event (Akan muncul di Pop-up)</label>
                        <input type="text" id="eventTitle" placeholder="Contoh: Diskon Servis AC 50%" required>
                    </div>
                    <div class="form-group">
                        <label for="eventMessage">Pesan Detail (Isi Pop-up)</label>
                        <textarea id="eventMessage" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="eventColor">Warna Pop-up (Background)</label>
                        <select id="eventColor">
                            <option value="var(--primary)">Biru (Primary)</option>
                            <option value="var(--secondary)">Oranye (Secondary)</option>
                            <option value="var(--success)">Hijau (Success)</option>
                            <option value="var(--danger)">Merah (Danger)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventStart">Mulai Event</label>
                        <input type="datetime-local" id="eventStart" required>
                    </div>
                    <div class="form-group">
                        <label for="eventEnd">Akhir Event</label>
                        <input type="datetime-local" id="eventEnd" required>
                    </div>
                    <div class="form-group">
                        <label>Event Pop-up Dismiss</label>
                        <div>
                            <input type="checkbox" id="eventDismiss" checked>
                            <label for="eventDismiss" style="display: inline; font-weight: normal;">Izinkan user menyembunyikan pop-up secara permanen (Opsi: "Tidak muncul lagi")</label>
                        </div>
                    </div>
                    <button type="submit" class="btn">Simpan/Update Event</button>
                    <button type="button" class="btn btn-danger" onclick="deleteEvent()" style="margin-left: 10px;">Hapus Event</button>
                </form>

                <div class="card" style="margin-top: 20px; background: var(--primary-light);">
                    <p style="font-weight: 600;">Status Event Saat Ini:</p>
                    <p id="currentEventStatus">Memuat...</p>
                </div>
            </div>
          </div>
          
          <!-- Tab Konten: Kelola Pesanan -->
          <div id="ordersPage" class="page-content" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Daftar Pesanan Terbaru</h3>
              </div>
              <p id="ordersList">Memuat data pesanan...</p>
            </div>
          </div>
          
          <!-- Tab Konten: User List -->
          <div id="usersPage" class="page-content" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Semua Pengguna Terdaftar</h3>
              </div>
              <p id="usersList">Memuat data pengguna...</p>
            </div>
          </div>
          
          <!-- Tab Konten: Sistem -->
          <div id="sistemPage" class="page-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Pengaturan Sistem Operasional</h3>
                </div>
                
                <div class="status-group">
                    <!-- Jam Buka/Tutup -->
                    <div class="card">
                        <h4 style="color: var(--secondary); margin-bottom: 15px;">Jam Buka Layanan</h4>
                        <div id="openStatusDisplay" class="status-card">
                            <p class="status-label">Memuat Status...</p>
                            <p class="status-time" id="scheduledTime"></p>
                        </div>
                        <div style="margin-top: 15px;">
                            <label for="openTime">Jam Buka (HH:mm)</label>
                            <input type="time" id="openTime" value="09:00">
                            <label for="closeTime">Jam Tutup (HH:mm)</label>
                            <input type="time" id="closeTime" value="19:00">
                            <button class="btn btn-sm" onclick="saveOperationalHours()" style="margin-top: 10px;">Simpan Jadwal</button>
                            <button class="btn btn-sm" onclick="toggleForceOpen()" id="forceToggleBtn" style="margin-top: 10px; background-color: var(--success);">Buka Sekarang</button>
                        </div>
                    </div>

                    <!-- Status Karyawan -->
                    <div class="card">
                        <h4 style="color: var(--secondary); margin-bottom: 15px;">Status Karyawan (Global)</h4>
                        <div class="form-group">
                            <label for="employeeStatus">Pilih Status Karyawan</label>
                            <select id="employeeStatus" onchange="saveEmployeeStatus()">
                                <option value="Siaga - Siap Mengerjakan">Siaga - Siap Mengerjakan</option>
                                <option value="Sedang Servis AC">Sedang Servis AC</option>
                                <option value="Sedang Cuci AC">Sedang Cuci AC</option>
                                <option option value="Sedang Instalasi">Sedang Instalasi</option>
                                <option value="Istirahat/Off Duty">Istirahat/Off Duty</option>
                            </select>
                        </div>
                        <p style="font-size: 0.9em; color: var(--gray);">Status ini akan muncul di widget Home Page.</p>
                    </div>
                </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <script>
      // === FIREBASE CONFIG & INIT (Disalin dari file Anda) ===
      const firebaseConfig = {
        apiKey: "AIzaSyDtLHSz7-KU97ALJTQvLRQTG5yj7brcsvc", 
        authDomain: "sejuk-teknik.firebaseapp.com",
        projectId: "sejuk-teknik",
        storageBucket: "sejuk-teknik.appspot.com",
        messagingSenderId: "733860478343",
        appId: "1:733860478343:web:172838a08e702d129ae722",
        measurementId: "G-EDJ6Y6J7GC"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // UID Admin (Harus sama dengan di Firebase Rules!)
      const ADMIN_UIDS = ['qE0yd2XNRSa0nWojtLvYoxLrsz22', 'JTVwtBsdt3PaaYeyICd8PJm3lJu2'];
      let isAdmin = false;
      let allReviews = [];
      let currentReplyReviewId = null;
      let targetUser = { uid: null, name: null, isAll: false }; // Untuk Kirim Notifikasi

      // --- UTILITY MODAL & ALERT FUNCTIONS ---

      function showCustomAlert(title, message, isError = false) {
        const modal = document.getElementById("genericAlertModal");
        const modalTitle = document.getElementById("alertTitle");
        const modalMessage = document.getElementById("alertMessage");
        const closeBtn = document.getElementById("alertCloseBtn");

        modalTitle.textContent = title;
        modalMessage.innerHTML = message;

        modalTitle.style.color = isError ? "var(--danger)" : "var(--primary)";
        closeBtn.textContent = isError ? "Baiklah üò•" : "Oke, Lanjut! üëç";
        closeBtn.style.backgroundColor = isError ? "var(--danger)" : "var(--primary)";

        modal.style.display = "flex";
        document.body.style.overflow = "hidden";

        closeBtn.onclick = () => {
          modal.style.display = "none";
          document.body.style.overflow = "auto";
        };
      }
      
      window.alert = function (message) {
        const isError = message.toLowerCase().includes("gagal") || message.toLowerCase().includes("error") || message.toLowerCase().includes("tolak");
        showCustomAlert(isError ? "Operasi Gagal! üíî" : "Sip, Berhasil! ‚úÖ", message, isError);
      };

      function escapeHtml(text) {
          if (!text) return '';
          return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/\'/g, '&#039;');
      }

      function renderStars(rating) {
          let starsHtml = '';
          for (let i = 1; i <= 5; i++) {
              starsHtml += `<i class="fa-star ${i <= rating ? 'fas' : 'far'}"></i>`;
          }
          return `<div class="review-stars">${starsHtml}</div>`;
      }

      function formatDateTimeLocal(date) {
          const y = date.getFullYear();
          const m = (date.getMonth() + 1).toString().padStart(2, '0');
          const d = date.getDate().toString().padStart(2, '0');
          const h = date.getHours().toString().padStart(2, '0');
          const min = date.getMinutes().toString().padStart(2, '0');
          return `${y}-${m}-${d}T${h}:${min}`;
      }
      
      // UPDATED: Time Ago Utility Function (Improved for past & future relative time)
      function timeAgo(date) {
          if (!date) return 'Waktu tidak tersedia';
          
          const seconds = Math.floor((new Date() - date) / 1000); // Positive for past, negative for future
          const isFuture = seconds < 0;
          const absSeconds = Math.abs(seconds);
          
          // Penyesuaian kata agar sesuai dengan konteks Bahasa Indonesia yang lebih baik
          const suffix = isFuture ? ' dari sekarang' : ' lalu';

          let interval = absSeconds / 31536000; // Years
          if (interval >= 1) { // Menggunakan >= 1 agar 1 tahun terhitung
              return Math.floor(interval) + " tahun" + suffix;
          }
          
          interval = absSeconds / 2592000; // Months (approx 30 days)
          if (interval >= 1) {
              return Math.floor(interval) + " bulan" + suffix;
          }
          
          interval = absSeconds / 86400; // Days
          if (interval >= 1) {
              return Math.floor(interval) + " hari" + suffix;
          }
          
          interval = absSeconds / 3600; // Hours
          if (interval >= 1) {
              return Math.floor(interval) + " jam" + suffix;
          }
          
          interval = absSeconds / 60; // Minutes
          if (interval >= 1) {
              return Math.floor(interval) + " menit" + suffix;
          }
          
          return "Baru saja";
      }

      
      // --- PAGE NAVIGATION ---
      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const page = this.getAttribute('data-page');
          
          // Update active menu
          document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
          this.classList.add('active');
          
          // Hide all pages
          document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
          
          // Show selected page
          document.getElementById(page + 'Page').style.display = 'block';
          
          // Update page title
          document.getElementById('pageTitle').textContent = this.textContent.trim();
          
          // Load page specific data
          if (page === 'dashboard') loadDashboard();
          if (page === 'reviews') loadReviews();
          if (page === 'orders') loadOrders();
          if (page === 'users') loadUsers();
          if (page === 'events') loadEventSettings();
          if (page === 'sistem') loadSystemSettings();
          
          // Close mobile menu if open
          if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('active');
          }
        });
      });
      
      // Mobile menu toggle
      document.getElementById('mobileMenuToggle').addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('active');
      });

      // --- ADMIN AUTH CHECK ---

      auth.onAuthStateChanged((user) => {
        if (user) {
            isAdmin = ADMIN_UIDS.includes(user.uid);
            if (isAdmin) {
                // Update user info in header
                document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
                document.getElementById('userAvatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
                
                // Load dashboard by default
                loadDashboard();
            } else {
                showCustomAlert("Akses Ditolak", "Anda bukan Admin. Akses ditolak.", true);
                document.querySelector('.main-content').innerHTML = '<div class="content"><div class="card"><p style="text-align:center; color: var(--danger);">Anda tidak memiliki izin untuk mengakses halaman ini.</p></div></div>';
            }
        } else {
            showCustomAlert("Login Diperlukan", "Anda harus Login sebagai Admin.", true);
            document.querySelector('.main-content').innerHTML = `
                <div class="content">
                    <div class="card" style="text-align:center;">
                        <p style="margin-bottom: 15px;">Silakan login dengan akun Admin.</p>
                        <button class="btn" onclick="window.location.href='index.html'">Pergi ke Halaman Utama</button>
                    </div>
                </div>
            `;
        }
      });
      
      document.getElementById('logoutBtn').addEventListener('click', () => {
          auth.signOut().then(() => {
              window.alert('Berhasil Logout.');
              window.location.reload(); 
          }).catch(error => {
              window.alert('Gagal Logout: ' + error.message);
          });
      });
      
      // --- DASHBOARD FUNCTIONS ---
      
      function loadDashboard() {
        checkSettingsInit(); // Pengecekan baru
        loadStatistics();
        loadCharts();
        loadRecentActivities();
      }
      
      // Fungsi Baru: Cek apakah koleksi settings/operational sudah ada (NEW)
      function checkSettingsInit() {
          const initCard = document.getElementById('settingsInitCard');
          
          db.collection('settings').doc('operational').get()
              .then(doc => {
                  if (!doc.exists) {
                      initCard.style.display = 'block';
                  } else {
                      initCard.style.display = 'none';
                  }
              })
              .catch(e => {
                  console.error('Error checking settings doc:', e);
                  // Tampilkan kartu jika gagal cek (fail-safe)
                  initCard.style.display = 'block'; 
              });
      }
      
      // Fungsi Baru: Inisialisasi Koleksi Settings (NEW)
      function initializeDefaultSettings() {
          const db = firebase.firestore();
          const batch = db.batch();
          
          if (!confirm("Yakin ingin membuat data pengaturan sistem default? Ini akan membuat 2 dokumen di koleksi 'settings'.")) {
              return;
          }

          // --- 1. DEFAULT OPERATIONAL SETTINGS ---
          const operationalRef = db.collection('settings').doc('operational');
          const operationalData = {
              openTime: '09:00', 
              closeTime: '19:00', 
              employeeStatus: 'Siaga - Siap Mengerjakan', 
              forceStatus: null, 
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          batch.set(operationalRef, operationalData);

          // --- 2. DEFAULT EVENT POP-UP (Non-aktif secara default) ---
          const eventRef = db.collection('settings').doc('event_popup');
          const pastDate = new Date();
          pastDate.setDate(pastDate.getDate() - 1); 
          
          const eventData = {
              title: 'Selamat Datang!',
              message: 'Ini adalah event pop-up default. Silakan ganti di Admin Panel.',
              color: 'var(--primary)',
              start: firebase.firestore.Timestamp.fromDate(pastDate),
              end: firebase.firestore.Timestamp.fromDate(pastDate),
              dismissible: true,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          batch.set(eventRef, eventData);

          // --- COMMIT BATCH ---
          batch.commit()
              .then(() => {
                  window.alert('Data Setting Default berhasil dibuat! Dashboard akan dimuat ulang.');
                  // Muat ulang dashboard untuk menyembunyikan tombol
                  loadDashboard();
              })
              .catch((error) => {
                  window.alert('Gagal membuat Data Setting Default: ' + error.message, true);
              });
      }
      
      function loadStatistics() {
        // Total Users
        db.collection('users').get().then(snapshot => {
          document.getElementById('totalUsers').textContent = snapshot.size;
        }).catch(e => console.error('Error loading users count:', e));
        
        // Total Orders
        db.collection('orders').get().then(snapshot => {
          document.getElementById('totalOrders').textContent = snapshot.size;
        }).catch(e => console.error('Error loading orders count:', e));
        
        // Total Reviews
        db.collection('reviews').get().then(snapshot => {
          document.getElementById('totalReviews').textContent = snapshot.size;
        }).catch(e => console.error('Error loading reviews count:', e));
        
        // Total Coins
        db.collection('users').get().then(snapshot => {
          let totalCoins = 0;
          snapshot.forEach(doc => {
            totalCoins += doc.data().sjcoin || 0;
          });
          document.getElementById('totalCoins').textContent = totalCoins;
        }).catch(e => console.error('Error loading coins count:', e));
      }
      
      function loadCharts() {
        // Orders Chart (Placeholder data)
        const ordersCtx = document.getElementById('ordersChart').getContext('2d');
        if (window.ordersChartInstance) window.ordersChartInstance.destroy();
        window.ordersChartInstance = new Chart(ordersCtx, {
          type: 'line',
          data: {
            labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
            datasets: [{
              label: 'Pesanan',
              data: [12, 19, 3, 5, 2, 3, 7],
              backgroundColor: 'rgba(0, 102, 204, 0.2)',
              borderColor: 'rgba(0, 102, 204, 1)',
              borderWidth: 2,
              tension: 0.3
            }]
          },
          options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { 
              y: { 
                beginAtZero: true 
              } 
            } 
          }
        });
        
        // Reviews Chart (Placeholder data)
        const reviewsCtx = document.getElementById('reviewsChart').getContext('2d');
        if (window.reviewsChartInstance) window.reviewsChartInstance.destroy();
        window.reviewsChartInstance = new Chart(reviewsCtx, {
          type: 'doughnut',
          data: {
            labels: ['5 Bintang', '4 Bintang', '3 Bintang', '2 Bintang', '1 Bintang'],
            datasets: [{
              data: [30, 15, 5, 3, 2],
              backgroundColor: [
                'rgba(76, 175, 80, 0.7)',
                'rgba(0, 102, 204, 0.7)',
                'rgba(255, 193, 7, 0.7)',
                'rgba(255, 152, 0, 0.7)',
                'rgba(244, 67, 54, 0.7)'
              ],
              borderColor: [
                'rgba(76, 175, 80, 1)',
                'rgba(0, 102, 204, 1)',
                'rgba(255, 193, 7, 1)',
                'rgba(255, 152, 0, 1)',
                'rgba(244, 67, 54, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }
      
      function loadRecentActivities() {
        const activitiesContainer = document.getElementById('recentActivities');
        activitiesContainer.innerHTML = '<p style="text-align:center;">Memuat aktivitas terbaru...</p>';
        
        // Asumsi data: reviews, orders, notifications
        const activitiesPromises = [
            db.collection('reviews').orderBy('timestamp', 'desc').limit(5).get(),
            db.collection('orders').orderBy('timestamp', 'desc').limit(5).get(),
            db.collection('notifications').orderBy('timestamp', 'desc').limit(5).get()
        ];
        
        Promise.all(activitiesPromises)
        .then(([reviewsSnapshot, ordersSnapshot, notificationsSnapshot]) => {
              let activities = [];
              
              reviewsSnapshot.forEach(doc => {
                const data = doc.data();
                activities.push({
                  type: 'review', title: `Ulasan baru dari ${data.reviewerName || 'Anonim'}`,
                  time: data.timestamp, icon: 'fa-star', color: 'warning'
                });
              });
              
              ordersSnapshot.forEach(doc => {
                const data = doc.data();
                activities.push({
                  type: 'order', title: `Pesanan baru dari ${data.userName || 'User'}`,
                  time: data.timestamp, icon: 'fa-shopping-cart', color: 'success'
                });
              });
              
              notificationsSnapshot.forEach(doc => {
                const data = doc.data();
                activities.push({
                  type: 'notification', title: `Notifikasi: ${data.title}`,
                  time: data.timestamp, icon: 'fa-bell', color: 'primary'
                });
              });
              
              activities.sort((a, b) => {
                if (!a.time) return 1;
                if (!b.time) return -1;
                return b.time.toDate() - a.time.toDate();
              });
              
              activities = activities.slice(0, 5); // Ambil 5 teratas
              
              // Render activities
              if (activities.length === 0) {
                activitiesContainer.innerHTML = '<p style="text-align:center;">Belum ada aktivitas terbaru.</p>';
                return;
              }
              
              let activitiesHtml = '<ul style="list-style: none; padding: 0;">';
              activities.forEach(activity => {
                const date = activity.time ? activity.time.toDate() : new Date();
                const formattedTime = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const formattedDate = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                
                activitiesHtml += `
                  <li style="padding: 10px 0; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background-color: var(--${activity.color}-light); color: var(--${activity.color}); display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                      <i class="fas ${activity.icon}"></i>
                    </div>
                    <div style="flex: 1;">
                      <p style="margin: 0; font-weight: 500;">${activity.title}</p>
                      <p style="margin: 0; font-size: 0.8rem; color: var(--gray);">${formattedDate}, ${formattedTime}</p>
                    </div>
                  </li>
                `;
              });
              activitiesHtml += '</ul>';
              
              activitiesContainer.innerHTML = activitiesHtml;
        })
        .catch(e => {
          activitiesContainer.innerHTML = `<p style="text-align:center; color: var(--danger);">Gagal memuat aktivitas: ${e.message}</p>`;
        });
      }
      
      // --- REVIEW MANAGEMENT FUNCTIONS (Review Tab) ---
      
      function loadReviews() { 
        const list = document.getElementById('reviewsList');
        list.innerHTML = '<p style="text-align:center;">Memuat ulasan...</p>';
        
        db.collection('reviews').orderBy('timestamp','desc').get().then(snapshot=>{
            allReviews = snapshot.docs.map(doc=>({...doc.data(), id:doc.id, sentiment:(doc.data().rating>=4?'positif':doc.data().rating===3?'netral':'negatif')}));
            renderReviewsList();
        }).catch(e => {
            list.innerHTML = `<p style="text-align:center; color: var(--danger);">Gagal memuat ulasan. (${e.message})</p>`;
        });
      }

      function renderReviewsList(){ 
          const list = document.getElementById('reviewsList'); 
          list.innerHTML='';
          if(allReviews.length===0){ list.innerHTML='<p style="text-align:center;">Belum ada ulasan.</p>'; return; }
          
          allReviews.forEach(review=>{
              const card = document.createElement('div'); card.classList.add('review-card');
              const isPinned = review.pinned;
              const hasReply = review.reply && review.reply.text;
              const reviewDate = review.timestamp ? (review.timestamp.toDate ? review.timestamp.toDate() : new Date(review.timestamp.seconds * 1000)) : new Date(); // Convert Timestamp
              const timeDisplay = timeAgo(reviewDate); // UPDATED: Relative Time
              const sourceDisplay = review.source ? `<span style="font-size: 0.8em; color: var(--primary); margin-left: 10px;"><i class="fas fa-map-marked-alt"></i> ${review.source}</span>` : '';
              
              const sentimentClass = review.sentiment === 'positif' ? 'tag-positif' : (review.sentiment === 'netral' ? 'tag-netral' : 'tag-danger');

              card.innerHTML=`
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="review-header">
                        <span style="font-weight: 600;">${escapeHtml(review.reviewerName||'Anonim')}</span>
                        ${renderStars(review.rating)}
                    </div>
                    <p style="font-size: 0.85em; color: var(--gray);">${timeDisplay}</p>
                </div>
                <div class="review-body" style="margin-top: 5px; margin-bottom: 10px;">${escapeHtml(review.reviewText)}</div>
                ${hasReply ? `<div style="margin-top: 5px; font-style: italic; font-size: 0.9em; padding: 5px; border-left: 3px solid var(--secondary); background: var(--light);">Balasan Admin: ${escapeHtml(review.reply.text).substring(0, 80)}...</div>` : ''}
                <div class="review-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <div>
                        <span class="sentiment-tag ${sentimentClass}" style="background-color: var(--primary); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">${review.sentiment.toUpperCase()}</span>
                        ${sourceDisplay}
                    </div>
                    <div class="admin-controls">
                        <button class="btn btn-sm" style="margin-right: 5px;" onclick="openReplyModal('${review.id}', '${escapeHtml(review.reviewerName||'Anonim')}', '${escapeHtml(review.reply?.text || '')}')">
                            ${hasReply ? 'Edit Balasan' : 'Balas'}
                        </button>
                        <button class="btn btn-sm" style="background-color: ${isPinned ? 'var(--gray)' : 'var(--secondary)'}; border-color: ${isPinned ? 'var(--gray)' : 'var(--secondary)'};" onclick="togglePin('${review.id}', ${!isPinned})">
                            ${isPinned ? 'Unpin' : 'üìå Pin'}
                        </button>
                        <button class="btn btn-danger btn-sm" style="margin-left: 5px;" onclick="deleteReview('${review.id}')">Hapus</button>
                    </div>
                </div>
              `;
              list.appendChild(card);
          });
      }

      function togglePin(reviewId, isPinned) { 
          db.collection('reviews').doc(reviewId).update({
              pinned: isPinned
          })
          .then(() => {
              window.alert(`Ulasan berhasil di-${isPinned ? 'pin' : 'unpin'}!`);
              loadReviews(); 
          })
          .catch(error => {
              window.alert('Gagal mengubah status pin: ' + error.message, true);
          });
      }

      function deleteReview(reviewId) { 
          if (!confirm("Apakah Anda yakin ingin menghapus ulasan ini secara permanen?")) return; // Ganti dengan modal konfirmasi jika mau
          
          db.collection('reviews').doc(reviewId).delete()
          .then(() => {
              window.alert('Ulasan berhasil dihapus.');
              loadReviews();
          })
          .catch(error => {
              window.alert('Gagal menghapus ulasan: ' + error.message, true);
          });
      }

      // --- NEW: ADMIN ADD REVIEW MODAL FUNCTIONS ---
      
      function openAddReviewModal() {
          const modal = document.getElementById('addReviewModal');
          const form = document.getElementById('addReviewForm');
          
          // Reset form
          form.reset();
          document.getElementById('newReviewerName').value = 'Anonim';
          document.getElementById('newReviewRating').value = '5'; // Default to 5
          
          // Set default timestamp to a past date (e.g., 1 day ago) for easier input
          const oneDayAgo = new Date();
          oneDayAgo.setDate(oneDayAgo.getDate() - 1);
          document.getElementById('newReviewTimestamp').value = formatDateTimeLocal(oneDayAgo);

          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
      }

      function closeAddReviewModal() {
          document.getElementById('addReviewModal').style.display = 'none';
          document.body.style.overflow = 'auto';
      }
      
      document.getElementById('addReviewForm').addEventListener('submit', addNewReview);

      function addNewReview(e) {
          e.preventDefault();
          
          const saveBtn = document.getElementById('saveNewReviewBtn');
          saveBtn.disabled = true;
          saveBtn.textContent = 'Menyimpan...';

          const reviewerName = document.getElementById('newReviewerName').value.trim();
          const rating = parseInt(document.getElementById('newReviewRating').value);
          const reviewText = document.getElementById('newReviewText').value.trim();
          const timestampInput = document.getElementById('newReviewTimestamp').value;
          
          if (reviewText.length < 5) {
              window.alert('Isi ulasan minimal 5 karakter.', true);
              saveBtn.disabled = false;
              saveBtn.textContent = 'Simpan Ulasan Baru';
              return;
          }

          const reviewTimestamp = new Date(timestampInput);
          
          const newReviewData = {
              reviewerName: reviewerName,
              reviewText: reviewText,
              rating: rating,
              timestamp: firebase.firestore.Timestamp.fromDate(reviewTimestamp),
              source: 'Google Maps (Admin Added)', 
              userId: 'admin_added_' + Date.now(), 
              reply: null,
              pinned: false,
              likes: [],
              dislikes: []
          };

          db.collection('reviews').add(newReviewData)
              .then(() => {
                  window.alert('Ulasan baru dari Google Maps berhasil ditambahkan!');
                  closeAddReviewModal();
                  loadReviews(); // Reload the list
                  saveBtn.disabled = false;
                  saveBtn.textContent = 'Simpan Ulasan Baru';
              })
              .catch(error => {
                  console.error('Error adding new review:', error);
                  window.alert('Gagal menambahkan ulasan baru: ' + error.message, true);
                  saveBtn.disabled = false;
                  saveBtn.textContent = 'Simpan Ulasan Baru';
              });
      }


      // --- ADMIN REPLY MODAL FUNCTIONS ---
      
      function openReplyModal(reviewId, reviewerName, existingText) { 
          currentReplyReviewId = reviewId;
          document.getElementById('replyReviewerName').textContent = reviewerName;
          document.getElementById('replyTextarea').value = existingText || '';
          document.getElementById('replyModal').style.display = 'flex';
          document.body.style.overflow = 'hidden';
      }
      
      function closeReplyModal() { 
          document.getElementById('replyModal').style.display = 'none';
          document.body.style.overflow = 'auto';
          currentReplyReviewId = null;
      }
      
      document.getElementById('sendReplyBtn').addEventListener('click', sendReply);

      function sendReply() { 
          const replyText = document.getElementById('replyTextarea').value.trim();
          if (replyText.length < 5) {
              window.alert('Balasan minimal 5 karakter.');
              return;
          }

          const user = auth.currentUser;

          db.collection('users').doc(user.uid).get().then(doc => {
              const adminName = doc.exists && doc.data().name ? doc.data().name : (user.displayName || 'Admin Sejuk Teknik');
              
              const updateData = {
                  reply: {
                      text: replyText,
                      adminName: adminName,
                      adminUid: user.uid,
                      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                      likes: [],
                      dislikes: []
                  }
              };

              return db.collection('reviews').doc(currentReplyReviewId).update(updateData);
          })
          .then(() => {
              closeReplyModal();
              window.alert('Balasan admin berhasil dikirim/diubah!');
              loadReviews(); 
          })
          .catch(error => {
              console.error('Error sending reply:', error);
              window.alert('Gagal mengirim balasan: ' + error.message, true);
          });
      }

      // --- NOTIFICATION MANAGEMENT (Notif Tab) ---

      // Event listener untuk saran judul
      document.getElementById('notifTitleSelect').addEventListener('change', function() {
          const select = this;
          const input = document.getElementById('notifTitle');
          if (select.value !== 'CUSTOM') {
              input.value = select.value;
          }
          input.focus();
      });

      // 1. User Search Logic
      document.getElementById('userSearch').addEventListener('input', debounce(() => {
        const query = document.getElementById('userSearch').value.toLowerCase().trim();
        const resultsContainer = document.getElementById('userSearchResults');
        resultsContainer.style.display = 'none';
        resultsContainer.innerHTML = '';
        
        // Cek mode Broadcast
        if (query === 'all' || query === 'All' || query === 'ALL') {
            targetUser = { uid: 'ALL_BROADCAST', name: 'SEMUA PENGGUNA', isAll: true };
            document.getElementById('selectedUserName').textContent = 'SEMUA PENGGUNA';
            document.getElementById('selectedUserUID').textContent = '(BROADCAST MODE)';
            document.getElementById('selectedUser').style.display = 'block';
            resultsContainer.innerHTML = '<p style="padding: 10px; font-weight: 600;">Mode BROADCAST dipilih. Notifikasi akan dikirim ke semua user terdaftar.</p>';
            resultsContainer.style.display = 'block';
            return;
        } else {
            targetUser = { uid: null, name: null, isAll: false };
            document.getElementById('selectedUser').style.display = 'none';
        }
        
        // Reset target user jika kotak pencarian kurang dari 3
        if (query.length < 3) {
            resultsContainer.innerHTML = '<p style="padding: 10px;">Ketik minimal 3 huruf.</p>';
            return;
        }
        
        resultsContainer.innerHTML = '<p style="padding: 10px; color: var(--primary);">Mencari...</p>';
        resultsContainer.style.display = 'block';


        // --- GABUNGKAN PENCARIAN NAMA DAN EMAIL ---
        const searchPromises = [
          db.collection('users').where('name', '>=', query).where('name', '<=', query + '\uf8ff').limit(10).get(),
          db.collection('users').where('email', '>=', query).where('email', '<=', query + '\uf8ff').limit(10).get()
        ];

        Promise.all(searchPromises)
          .then(results => {
            const nameSnapshot = results[0];
            const emailSnapshot = results[1];
            const combinedDocs = {};

            nameSnapshot.docs.forEach(doc => combinedDocs[doc.id] = { id: doc.id, ...doc.data() });
            emailSnapshot.docs.forEach(doc => combinedDocs[doc.id] = { id: doc.id, ...doc.data() });

            const users = Object.values(combinedDocs);
            
            resultsContainer.innerHTML = '';

            if (users.length === 0) {
                resultsContainer.innerHTML = '<p style="padding: 10px;">User tidak ditemukan.</p>';
                return;
            }

            users.forEach(user => {
                const item = document.createElement('div');
                item.classList.add('user-list-item');
                item.setAttribute('data-uid', user.id);
                const displayName = escapeHtml(user.name || user.email.split('@')[0]);
                item.setAttribute('data-name', displayName); 
                
                item.innerHTML = `
                  <strong>${displayName}</strong> 
                  <span style="font-size: 0.9em; color: var(--gray);">${escapeHtml(user.email)}</span> 
                  <span style="font-size: 0.7em; color: var(--gray); display: block;">UID: ${user.id.substring(0, 8)}...</span>
                `;
                
                item.addEventListener('click', selectUser);
                resultsContainer.appendChild(item);
            });
          })
          .catch(e => {
            resultsContainer.innerHTML = `<p style="padding: 10px; color: var(--danger);">Gagal mencari user: ${e.message}</p>`;
          });
      }, 500)); 

      function debounce(func, delay) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
      }
      
      function selectUser(e) {
          const selectedItem = e.target.closest('.user-list-item');
          if (!selectedItem) return;

          document.querySelectorAll('.user-list-item').forEach(item => item.classList.remove('selected'));
          selectedItem.classList.add('selected');

          targetUser.uid = selectedItem.getAttribute('data-uid');
          targetUser.name = selectedItem.getAttribute('data-name');
          targetUser.isAll = false;
          
          document.getElementById('selectedUserName').textContent = targetUser.name;
          document.getElementById('selectedUserUID').textContent = targetUser.uid;
          document.getElementById('selectedUser').style.display = 'block';
          document.getElementById('userSearchResults').style.display = 'none';
          document.getElementById('userSearch').value = targetUser.name; 
      }
      
      // 2. Kirim Notifikasi Logic
      document.getElementById('notificationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const sendNotifBtn = document.getElementById('sendNotifBtn');
        
        if (!targetUser.uid) {
            window.alert('Pilih pengguna tujuan terlebih dahulu.');
            return;
        }

        const title = document.getElementById('notifTitle').value.trim();
        const content = document.getElementById('notifContent').value.trim();
        const coinReward = parseInt(document.getElementById('coinReward').value) || 0;
        
        if (title.length < 3) {
            window.alert('Judul minimal 3 karakter.');
            return;
        }
        if (content.length < 5) {
            window.alert('Isi Pesan minimal 5 karakter.');
            return;
        }
        
        sendNotifBtn.disabled = true;
        sendNotifBtn.textContent = 'Mengirim...';
        
        // LOGIKA KIRIM NOTIFIKASI
        if (targetUser.isAll) {
            // MODE BROADCAST
            db.collection('users').get().then(snapshot => {
                const batch = db.batch();
                let sentCount = 0;
                
                snapshot.forEach(userDoc => {
                    const notificationData = {
                        userId: userDoc.id, // UID setiap user
                        title: title,
                        content: content,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false,
                        claimed: false,
                        coinReward: coinReward
                    };
                    batch.set(db.collection('notifications').doc(), notificationData);
                    sentCount++;
                });

                return batch.commit().then(() => sentCount);
            })
            .then((sentCount) => {
                window.alert(`SUCCESS: Notifikasi berhasil dikirim ke ${sentCount} pengguna.`);
                // Reset UI
                document.getElementById('notificationForm').reset();
                targetUser = { uid: null, name: null, isAll: false };
                document.getElementById('selectedUser').style.display = 'none';
                document.getElementById('userSearch').value = ''; 
                sendNotifBtn.textContent = 'Kirim Notifikasi';
                sendNotifBtn.disabled = false;
            })
            .catch(error => {
                window.alert('Gagal mengirim notifikasi BROADCAST: ' + error.message, true);
                sendNotifBtn.textContent = 'Kirim Notifikasi';
                sendNotifBtn.disabled = false;
            });

        } else {
            // MODE INDIVIDUAL
            const notificationData = {
                userId: targetUser.uid,
                title: title,
                content: content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false,
                claimed: false,
                coinReward: coinReward
            };
            
            db.collection('notifications').add(notificationData)
            .then(() => {
                window.alert(`Notifikasi berhasil dikirim ke ${targetUser.name}. Hadiah: ${coinReward} SJCoin.`);
                
                // Reset UI
                document.getElementById('notificationForm').reset();
                targetUser = { uid: null, name: null, isAll: false };
                document.getElementById('selectedUser').style.display = 'none';
                document.getElementById('userSearch').value = ''; 
                sendNotifBtn.textContent = 'Kirim Notifikasi';
                sendNotifBtn.disabled = false;
            })
            .catch(error => {
                window.alert('Gagal mengirim notifikasi: ' + error.message, true);
                sendNotifBtn.textContent = 'Kirim Notifikasi';
                sendNotifBtn.disabled = false;
            });
        }
      });


      // --- EVENT POP-UP MANAGEMENT (Events Tab) ---

      function loadEventSettings() {
          const form = document.getElementById('eventForm');
          const statusDisplay = document.getElementById('currentEventStatus');
          statusDisplay.textContent = 'Memuat...';

          db.collection('settings').doc('event_popup').get()
              .then(doc => {
                  if (doc.exists) {
                      const data = doc.data();
                      document.getElementById('eventTitle').value = data.title || '';
                      document.getElementById('eventMessage').value = data.message || '';
                      document.getElementById('eventColor').value = data.color || 'var(--primary)';
                      document.getElementById('eventStart').value = data.start ? formatDateTimeLocal(data.start.toDate()) : '';
                      document.getElementById('eventEnd').value = data.end ? formatDateTimeLocal(data.end.toDate()) : '';
                      document.getElementById('eventDismiss').checked = data.dismissible !== false;
                      
                      renderEventStatus(data);
                  } else {
                      statusDisplay.innerHTML = 'Belum ada event pop-up yang tersimpan.';
                  }
              })
              .catch(e => {
                  statusDisplay.innerHTML = `Gagal memuat event: ${e.message}`;
              });
      }

      function saveEvent(e) {
          e.preventDefault();
          
          const start = new Date(document.getElementById('eventStart').value);
          const end = new Date(document.getElementById('eventEnd').value);

          if (start >= end) {
              window.alert('Tanggal Mulai harus sebelum Tanggal Berakhir.', true);
              return;
          }
          
          const eventData = {
              title: document.getElementById('eventTitle').value.trim(),
              message: document.getElementById('eventMessage').value.trim(),
              color: document.getElementById('eventColor').value,
              start: firebase.firestore.Timestamp.fromDate(start),
              end: firebase.firestore.Timestamp.fromDate(end),
              dismissible: document.getElementById('eventDismiss').checked,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          db.collection('settings').doc('event_popup').set(eventData)
              .then(() => {
                  window.alert('Event Pop-up berhasil disimpan/diperbarui! Akan segera muncul di Home Page.');
                  loadEventSettings();
              })
              .catch(e => {
                  window.alert('Gagal menyimpan event: ' + e.message, true);
              });
      }
      
      document.getElementById('eventForm').addEventListener('submit', saveEvent);

      function deleteEvent() {
          if (!confirm("Apakah Anda yakin ingin MENGHAPUS Event Pop-up ini? (Ini akan segera hilang dari Home Page)")) return;

          db.collection('settings').doc('event_popup').delete()
              .then(() => {
                  window.alert('Event Pop-up berhasil dihapus.');
                  loadEventSettings();
              })
              .catch(e => {
                  window.alert('Gagal menghapus event: ' + e.message, true);
              });
      }

      function renderEventStatus(data) {
          const statusDisplay = document.getElementById('currentEventStatus');
          const now = new Date();
          const start = data.start ? data.start.toDate() : null;
          const end = data.end ? data.end.toDate() : null;

          let statusText = '';
          let statusColor = '';

          if (!start || !end) {
              statusText = 'TIDAK AKTIF: Event belum diatur.';
              statusColor = 'var(--gray)';
          } else if (now < start) {
              statusText = `BELUM MULAI. Aktif pada: ${start.toLocaleString('id-ID')}`;
              statusColor = 'var(--primary)';
          } else if (now >= start && now <= end) {
              statusText = `LIVE. Berakhir pada: ${end.toLocaleString('id-ID')}`;
              statusColor = 'var(--success)';
          } else {
              statusText = `KEDALUWARSA. Berakhir pada: ${end.toLocaleString('id-ID')}`;
              statusColor = 'var(--danger)';
          }

          statusDisplay.innerHTML = `<p style="color: ${statusColor};">${statusText}</p>
                                     <p><strong>Judul:</strong> ${escapeHtml(data.title)}</p>
                                     <p><strong>Pesan:</strong> ${escapeHtml(data.message.substring(0, 80))}...</p>`;
      }
      
      
      // --- SYSTEM MANAGEMENT (Sistem Tab) ---

      let currentSystemSettings = {};

      function loadSystemSettings() {
          const display = document.getElementById('openStatusDisplay');
          const forceBtn = document.getElementById('forceToggleBtn');

          db.collection('settings').doc('operational').onSnapshot(doc => {
              if (doc.exists) {
                  currentSystemSettings = doc.data();
                  
                  // Display Waktu Operasional
                  document.getElementById('openTime').value = currentSystemSettings.openTime || '09:00';
                  document.getElementById('closeTime').value = currentSystemSettings.closeTime || '19:00';
                  document.getElementById('scheduledTime').textContent = `Jadwal: ${currentSystemSettings.openTime || '09:00'} - ${currentSystemSettings.closeTime || '19:00'} WIB`;

                  // Display Status Karyawan
                  document.getElementById('employeeStatus').value = currentSystemSettings.employeeStatus || 'Siaga - Siap Mengerjakan';

                  // Display Status Buka/Tutup
                  const isOpen = checkServiceStatus(currentSystemSettings);
                  display.classList.remove('status-open', 'status-closed');
                  display.classList.add(isOpen ? 'status-open' : 'status-closed');
                  display.querySelector('.status-label').textContent = isOpen ? 'LAYANAN SEDANG DIBUKA' : 'LAYANAN SEDANG DITUTUP';

                  // Force Toggle Button
                  if (currentSystemSettings.forceStatus === 'open') {
                      forceBtn.textContent = 'Tutup Paksa (Aktif)';
                      forceBtn.style.backgroundColor = 'var(--danger)';
                  } else if (currentSystemSettings.forceStatus === 'close') {
                      forceBtn.textContent = 'Buka Paksa (Aktif)';
                      forceBtn.style.backgroundColor = 'var(--success)';
                  } else {
                      forceBtn.textContent = isOpen ? 'Tutup Paksa' : 'Buka Paksa';
                      forceBtn.style.backgroundColor = isOpen ? 'var(--danger)' : 'var(--success)';
                  }
              }
          });
      }

      function checkServiceStatus(settings) {
          const now = new Date();
          const localTime = now.getHours() * 60 + now.getMinutes();

          const [openH, openM] = (settings.openTime || '09:00').split(':').map(Number);
          const openMinutes = openH * 60 + openM;

          const [closeH, closeM] = (settings.closeTime || '19:00').split(':').map(Number);
          const closeMinutes = closeH * 60 + closeM;

          let isOpen = localTime >= openMinutes && localTime < closeMinutes;
          
          if (settings.forceStatus === 'open') {
              isOpen = true;
          } else if (settings.forceStatus === 'close') {
              isOpen = false;
          }
          
          return isOpen;
      }

      function saveOperationalHours() {
          const openTime = document.getElementById('openTime').value;
          const closeTime = document.getElementById('closeTime').value;
          
          db.collection('settings').doc('operational').update({
              openTime: openTime,
              closeTime: closeTime,
              forceStatus: null, // Reset force status saat jadwal diubah
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(() => {
              window.alert('Jadwal operasional berhasil diperbarui.');
          })
          .catch(e => {
              window.alert('Gagal menyimpan jadwal: ' + e.message, true);
          });
      }

      function toggleForceOpen() {
          const currentForceStatus = currentSystemSettings.forceStatus;
          let newForceStatus = null;
          
          if (currentForceStatus === 'open') {
              newForceStatus = 'close';
          } else if (currentForceStatus === 'close') {
              newForceStatus = null;
          } else {
              // Jika tidak ada force status, terapkan force open
              newForceStatus = 'open';
          }
          
          db.collection('settings').doc('operational').update({
              forceStatus: newForceStatus,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(() => {
              window.alert(`Status layanan berhasil diatur ke ${newForceStatus ? (newForceStatus === 'open' ? 'Buka Paksa' : 'Tutup Paksa') : 'Normal (Ikuti Jadwal)'}.`);
          })
          .catch(e => {
              window.alert('Gagal mengubah status paksa: ' + e.message, true);
          });
      }

      function saveEmployeeStatus() {
          const status = document.getElementById('employeeStatus').value;
          
          db.collection('settings').doc('operational').update({
              employeeStatus: status,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(() => {
              window.alert('Status karyawan berhasil diperbarui.');
          })
          .catch(e => {
              window.alert('Gagal menyimpan status karyawan: ' + e.message, true);
          });
      }

      // --- ORDER MANAGEMENT (Orders Tab) ---
      
      function loadOrders() { 
          const list = document.getElementById('ordersList');
          list.innerHTML = '<p>Memuat daftar pesanan...</p>';
          
          db.collection('orders').orderBy('timestamp', 'desc').limit(50).get()
          .then(snapshot => {
              if (snapshot.empty) {
                  list.innerHTML = '<p>Tidak ada pesanan aktif.</p>';
                  return;
              }
              
              let tableHtml = `
                  <table class="data-table">
                  <thead>
                      <tr>
                          <th>ID Pesanan</th>
                          <th>User</th>
                          <th>Layanan</th>
                          <th>Status</th>
                          <th>Waktu</th>
                          <th>Aksi</th>
                      </tr>
                  </thead>
                  <tbody>
              `;
              
              snapshot.forEach(doc => {
                  const order = doc.data();
                  const orderId = doc.id;
                  const date = order.timestamp ? (order.timestamp.toDate ? order.timestamp.toDate() : new Date(order.timestamp.seconds * 1000)) : new Date();
                  const formattedTime = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' });
                  
                  tableHtml += `
                      <tr>
                          <td>${orderId.substring(0, 6)}...</td>
                          <td>${order.userName || order.userId.substring(0, 6)}...</td>
                          <td>${order.serviceType || 'N/A'}</td>
                          <td><span style="color: ${order.status === 'Selesai' ? 'var(--success)' : (order.status === 'Baru' ? 'var(--secondary)' : 'var(--primary)')}; font-weight: 600;">${order.status || 'Baru'}</span></td>
                          <td>${formattedTime}</td>
                          <td>
                              <button class="btn btn-sm" onclick="viewOrder('${orderId}')">Detail</button>
                              <button class="btn-danger btn-sm" onclick="deleteOrder('${orderId}')">Hapus</button>
                          </td>
                      </tr>
                  `;
              });
              
              list.innerHTML = tableHtml + '</tbody></table>';
          })
          .catch(e => {
              list.innerHTML = `<p style="color: var(--danger);">Gagal memuat pesanan. (${e.message})</p>`;
          });
      }
      
      function viewOrder(orderId) { 
          window.alert(`Menampilkan detail untuk Order ID: ${orderId}. Implementasi detail penuh belum tersedia.`);
      }
      
      function deleteOrder(orderId) { 
          if (!confirm("Yakin ingin menghapus pesanan ini?")) return;
          
          db.collection('orders').doc(orderId).delete()
          .then(() => {
              window.alert('Pesanan berhasil dihapus.');
              loadOrders();
          })
          .catch(e => {
              window.alert('Gagal menghapus pesanan: ' + e.message, true);
          });
      }

      // --- USER LIST MANAGEMENT (Users Tab) ---

      function loadUsers() { 
        const list = document.getElementById('usersList');
        list.innerHTML = '<p>Memuat daftar pengguna...</p>';

        db.collection('users').orderBy('createdAt', 'desc').limit(100).get()
        .then(snapshot => {
            if (snapshot.empty) {
                list.innerHTML = '<p>Tidak ada pengguna terdaftar.</p>';
                return;
            }

            let tableHtml = `
                  <table class="data-table">
                  <thead>
                      <tr>
                          <th>Nama</th>
                          <th>Email</th>
                          <th>SJCoin</th>
                          <th>Bergabung</th>
                          <th>Aksi</th>
                      </tr>
                  </thead>
                  <tbody>
              `;

            snapshot.forEach(doc => {
                const user = doc.data();
                const userId = doc.id;
                const date = user.createdAt ? (user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt.seconds * 1000)) : new Date();
                const formattedDate = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
                
                tableHtml += `
                    <tr onclick="viewUserDetail('${userId}')" style="cursor: pointer;">
                        <td>${escapeHtml(user.name || 'N/A')}</td>
                        <td>${escapeHtml(user.email || 'N/A')}</td>
                        <td><span style="color: var(--coin); font-weight: 600;">${user.sjcoin || 0}</span></td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="btn btn-sm" onclick="event.stopPropagation(); viewUserDetail('${userId}')">Detail</button>
                        </td>
                    </tr>
                `;
            });

            list.innerHTML = tableHtml + '</tbody></table>';
        })
        .catch(e => {
            list.innerHTML = `<p style="color: var(--danger);">Gagal memuat daftar pengguna. (${e.message})</p>`;
        });
      }

      function viewUserDetail(userId) { 
          db.collection('users').doc(userId).get()
          .then(doc => {
              if (!doc.exists) {
                  window.alert('Detail pengguna tidak ditemukan.', true);
                  return;
              }
              const user = doc.data();
              const date = user.createdAt ? (user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt.seconds * 1000)) : new Date();
              const formattedDate = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });

              document.getElementById('userDetailTitle').textContent = `Detail Pengguna: ${user.name || user.email}`;
              document.getElementById('detailName').textContent = user.name || 'Belum diisi';
              document.getElementById('detailEmail').textContent = user.email || 'N/A';
              document.getElementById('detailAddress').textContent = user.address || 'Belum diisi';
              document.getElementById('detailPhone').textContent = user.phone || 'Belum diisi';
              document.getElementById('detailSJCoin').textContent = user.sjcoin || 0;
              document.getElementById('detailJoined').textContent = formattedDate;
              document.getElementById('detailUID').textContent = userId;
              
              document.getElementById('userDetailModal').setAttribute('data-target-uid', userId);

              openUserDetailModal();
          })
          .catch(e => {
              window.alert('Gagal mengambil detail pengguna: ' + e.message, true);
          });
      }
      
      function openUserDetailModal() { 
          document.getElementById('userDetailModal').style.display = 'flex';
          document.body.style.overflow = 'hidden';
      }

      function closeUserDetailModal() { 
          document.getElementById('userDetailModal').style.display = 'none';
          document.body.style.overflow = 'auto';
      }

      function deleteUser() { 
          const userId = document.getElementById('userDetailModal').getAttribute('data-target-uid');
          if (!userId) return;
          
          if (!confirm(`Yakin ingin MENGHAPUS PERMANEN pengguna ini: ${userId}? (Semua data akan hilang!)`)) return;
          
          db.collection('users').doc(userId).delete()
          .then(() => {
              window.alert(`Data pengguna ${userId.substring(0, 8)}... berhasil dihapus dari Firestore. **PENTING:** Hapus juga akunnya dari Firebase Authentication Console!`);
              closeUserDetailModal();
              loadUsers();
          })
          .catch(e => {
              window.alert('Gagal menghapus data pengguna: ' + e.message, true);
          });
      }
      
    </script>
  </body>
</html>
