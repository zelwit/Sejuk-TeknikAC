<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel | Sejuk Teknik AC</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-firestore-compat.js"></script> 
    <style>
      /* --- VARIABEL & RESET DASAR --- */
      :root {
        --primary: #0066cc;
        --primary-light: #e6f2ff;
        --secondary: #ff7a00;
        --dark: #2d3748;
        --light: #f8fafc;
        --gray: #718096;
        --white: #ffffff;
        --coin: #ffd700;
        --success: #4caf50;
        --danger: #f44336;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Poppins", sans-serif;
        color: var(--dark);
        line-height: 1.6;
        background-color: var(--light);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .container {
        padding: 1.5rem;
        max-width: 1000px;
        width: 100%;
        margin: 0 auto;
        flex-grow: 1;
      }
      .btn {
        display: inline-block;
        background-color: var(--primary);
        color: var(--white);
        padding: 0.6rem 1rem;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        border: 2px solid var(--primary);
        cursor: pointer;
        text-align: center;
      }
      .btn:hover {
        background-color: transparent;
        color: var(--primary);
      }
      .btn-danger {
        background-color: var(--danger);
        border-color: var(--danger);
      }
      .btn-danger:hover {
        color: var(--danger);
        background-color: transparent;
      }
      
      /* --- Header & Tabs --- */
      header {
        background: var(--dark);
        color: var(--white);
        padding: 1.5rem;
        text-align: center;
      }
      .tabs {
        display: flex;
        justify-content: center;
        margin-top: 1rem;
        border-bottom: 2px solid #ddd;
      }
      .tab-btn {
        background: transparent;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 600;
        color: var(--gray);
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }
      .tab-btn.active {
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
      }
      .tab-content {
        padding: 1.5rem 0;
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      /* --- Cards & Forms --- */
      .card {
        background: var(--white);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-family: "Poppins", sans-serif;
      }
      
      /* --- Review List Styles --- */
      .review-card {
        background: var(--light);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 5px solid var(--primary);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .review-stars i {
        color: #ffc107;
      }
      .review-footer {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        margin-top: 0.5rem;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
      }
      .admin-controls button{
        margin-left:5px; cursor:pointer; border:none; 
        background:var(--secondary); color:var(--white);
        padding: 5px 10px; border-radius: 50px; font-weight:500;
      }
      .admin-controls button:hover{ opacity: 0.9; }
      .admin-controls .unpin-btn { background-color: var(--gray); }
      .admin-controls .edit-reply-btn { background-color: var(--primary); }
      
      /* Modal Styles (General) */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none; 
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      .modal-content {
        background: var(--white);
        padding: 1.5rem;
        border-radius: 12px;
        width: 90%;
        max-width: 450px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .modal-content h3 {
        margin-bottom: 1rem;
        color: var(--primary);
      }
      .modal-content textarea {
        width: 100%;
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-bottom: 1rem;
        resize: vertical;
      }
      .modal-content .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-weight: bold;
        border: none;
        background: transparent;
        font-size: 1.2rem;
      }
      .modal-footer {
          display: flex;
          justify-content: flex-end;
          gap: 10px;
      }

      /* Alert Modal & User Search Results */
      #genericAlertModal { z-index: 3000; }
      .confirm-yes.error-style { background-color: var(--danger); }
      .notification-list-target { 
          max-height: 400px; 
          overflow-y: auto;
          border: 1px solid #eee;
          border-radius: 8px;
          padding: 10px;
          background: var(--white);
      }
      .user-list-item {
          padding: 8px;
          border-bottom: 1px dashed #eee;
          cursor: pointer;
          transition: background-color 0.2s;
          line-height: 1.2;
      }
      .user-list-item:hover { background-color: var(--primary-light); }
      .user-list-item:last-child { border-bottom: none; }
      .user-list-item.selected { 
        background-color: var(--primary); 
        color: var(--white);
        font-weight: 600;
      }
      
      /* Order/User Table Styles */
      .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
      .data-table th, .data-table td { 
          border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9em;
      }
      .data-table th { background-color: var(--primary-light); color: var(--primary); }
      .data-table tr:nth-child(even) { background-color: #f9f9f9; }

      /* User Detail Modal Specific */
      .user-detail-list strong { display: inline-block; width: 120px; color: var(--primary); }
      .user-detail-list p { border-bottom: 1px dashed var(--light); padding-bottom: 5px; margin-bottom: 5px; }

    </style>
  </head>
  <body>
    
    <!-- Generic Alert Modal (Untuk feedback) -->
    <div id="genericAlertModal" class="modal-overlay">
      <div class="modal-content">
        <div class="confirm-title" id="alertTitle"></div>
        <div class="confirm-message" id="alertMessage"></div>
        <div class="modal-footer">
          <button class="btn confirm-yes" id="alertCloseBtn">
            Oke, Lanjut! üëç
          </button>
        </div>
      </div>
    </div>

    <!-- Modal for Admin Reply -->
    <div class="modal-overlay" id="replyModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeReplyModal()">√ó</button>
        <h3 id="replyModalTitle">Boss mau bales apa ke <span id="replyReviewerName"></span>?</h3>
        <textarea id="replyTextarea" rows="5" placeholder="Tulis balasan..."></textarea>
        <div class="modal-footer">
            <button class="btn" style="background-color: var(--gray);" onclick="closeReplyModal()">Batal</button>
            <button class="btn" id="sendReplyBtn">Kirim Balasan</button>
        </div>
      </div>
    </div>
    
    <!-- Modal for User Details -->
    <div class="modal-overlay" id="userDetailModal">
      <div class="modal-content" style="max-width: 550px;">
        <button class="close-btn" onclick="closeUserDetailModal()">√ó</button>
        <h3 id="userDetailTitle">Detail Pengguna: Loading...</h3>
        <div id="userDetailContent" class="user-detail-list">
           <p><strong>Nama:</strong> <span id="detailName"></span></p>
           <p><strong>Email:</strong> <span id="detailEmail"></span></p>
           <p><strong>Alamat:</strong> <span id="detailAddress"></span></p>
           <p><strong>No. HP:</strong> <span id="detailPhone"></span></p>
           <p><strong>SJCoin:</strong> <span id="detailSJCoin" style="color: var(--coin); font-weight: 600;"></span></p>
           <p><strong>Bergabung:</strong> <span id="detailJoined"></span></p>
           <p><strong>UID:</strong> <span id="detailUID" style="font-size: 0.9em;"></span></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="deleteUser()">Hapus User</button>
        </div>
      </div>
    </div>


    <header>
      <h1>Admin Panel</h1>
      <p id="authStatus"></p>
      <button class="btn btn-danger" id="logoutBtn" style="margin-top: 10px; display: none;">Logout</button>
      <div class="tabs" id="adminTabs" style="display: none;">
        <button class="tab-btn active" data-tab="reviews">Kelola Ulasan</button>
        <button class="tab-btn" data-tab="notif">Kirim Notifikasi</button>
        <button class="tab-btn" data-tab="orders">Kelola Pesanan</button>
        <button class="tab-btn" data-tab="users">User List</button>
      </div>
    </header>

    <div class="container">
      
      <!-- Tab Konten: Kelola Ulasan -->
      <div id="reviews" class="tab-content active">
        <div class="card">
            <h3>Daftar Ulasan Pelanggan</h3>
            <div id="reviewsList">
              <p style="text-align:center;">Memuat ulasan...</p>
            </div>
        </div>
      </div>
      
      <!-- Tab Konten: Kirim Notifikasi -->
      <div id="notif" class="tab-content">
        <div class="card">
            <h3>Kirim Hadiah/Pesan ke User</h3>
            <p>Pilih user yang akan menerima notifikasi. Ketik 'ALL' untuk broadcast.</p>
            
            <div id="userSearchArea" class="form-group">
                <input type="text" id="userSearch" placeholder="Cari User (Nama/Email) atau ketik ALL">
                <div id="userSearchResults" class="notification-list-target" style="margin-top: 10px; display: none;">
                    <!-- Hasil pencarian user -->
                </div>
                <p id="selectedUser" style="margin-top: 10px; font-weight: 600; color: var(--success); display: none;">
                    ‚úÖ Target: <span id="selectedUserName"></span> 
                    <span id="selectedUserUID" style="font-size: 0.8em; color: var(--gray);"></span>
                </p>
            </div>
            
            <div class="form-group">
                <label for="notifTitleSelect">Saran Judul</label>
                <select id="notifTitleSelect">
                    <option value="CUSTOM">-- Judul Kustom --</option>
                    <option value="Selamat Bergabung!">Selamat Bergabung!</option>
                    <option value="Hadiah Klaim Koin!">Hadiah Klaim Koin!</option>
                    <option value="Update Status Pesanan!">Update Status Pesanan!</option>
                    <option value="Promosi Terbaru!">Promosi Terbaru!</option>
                </select>
            </div>

            <form id="notificationForm" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="notifTitle">Judul Notifikasi</label>
                    <input type="text" id="notifTitle" required>
                </div>
                <div class="form-group">
                    <label for="notifContent">Isi Pesan</label>
                    <textarea id="notifContent" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="coinReward">Hadiah SJCoin (Opsional)</label>
                    <input type="number" id="coinReward" min="0" value="0">
                </div>
                <button type="submit" class="btn" id="sendNotifBtn">Kirim Notifikasi</button>
            </form>
        </div>
      </div>
      
      <!-- Tab Konten: Kelola Pesanan -->
      <div id="orders" class="tab-content">
        <div class="card">
          <h3>Daftar Pesanan Terbaru</h3>
          <p id="ordersList">Memuat data pesanan...</p>
        </div>
      </div>
      
      <!-- Tab Konten: User List -->
      <div id="users" class="tab-content">
        <div class="card">
          <h3>Semua Pengguna Terdaftar</h3>
          <p id="usersList">Memuat data pengguna...</p>
        </div>
      </div>

    </div>

    <script>
      // === FIREBASE CONFIG & INIT (Disalin dari file Anda) ===
      const firebaseConfig = {
        apiKey: "AIzaSyDtLHSz7-KU97ALJTQvLRQTG5yj7brcsvc", 
        authDomain: "sejuk-teknik.firebaseapp.com",
        projectId: "sejuk-teknik",
        storageBucket: "sejuk-teknik.appspot.com",
        messagingSenderId: "733860478343",
        appId: "1:733860478343:web:172838a08e702d129ae722",
        measurementId: "G-EDJ6Y6J7GC"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // UID Admin (Harus sama dengan di Firebase Rules!)
      const ADMIN_UIDS = ['f3M49osGvtcGbEWf9UTdJe1AG013', 'JTVwtBsdt3PaaYeyICd8PJm3lJu2'];
      let isAdmin = false;
      let allReviews = [];
      let currentReplyReviewId = null;
      // Diperbarui untuk mendukung mode 'ALL' (broadcast)
      let targetUser = { uid: null, name: null, isAll: false }; 

      // --- UTILITY MODAL & ALERT FUNCTIONS ---

      function showCustomAlert(title, message, isError = false) {
        const modal = document.getElementById("genericAlertModal");
        const modalTitle = document.getElementById("alertTitle");
        const modalMessage = document.getElementById("alertMessage");
        const closeBtn = document.getElementById("alertCloseBtn");

        modalTitle.textContent = title;
        modalMessage.innerHTML = message;

        modalTitle.style.color = isError ? "var(--danger)" : "var(--primary)";
        closeBtn.textContent = isError ? "Baiklah üò•" : "Oke, Lanjut! üëç";
        closeBtn.style.backgroundColor = isError ? "var(--danger)" : "var(--primary)";

        modal.style.display = "flex";
        document.body.style.overflow = "hidden";

        closeBtn.onclick = () => {
          modal.style.display = "none";
          document.body.style.overflow = "auto";
        };
      }
      
      window.alert = function (message) {
        const isError = message.toLowerCase().includes("gagal") || message.toLowerCase().includes("error") || message.toLowerCase().includes("tolak");
        showCustomAlert(isError ? "Operasi Gagal! üíî" : "Sip, Berhasil! ‚úÖ", message, isError);
      };

      function escapeHtml(text) {
          if (!text) return '';
          return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/\'/g, '&#039;');
      }

      function renderStars(rating) {
          let starsHtml = '';
          for (let i = 1; i <= 5; i++) {
              starsHtml += `<i class="fa-star ${i <= rating ? 'fas' : 'far'}"></i>`;
          }
          return `<div class="review-stars">${starsHtml}</div>`;
      }
      
      // --- TAB SWITCHING ---
      document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
          const tabId = button.getAttribute('data-tab');
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          
          button.classList.add('active');
          document.getElementById(tabId).classList.add('active');
          
          // Muat data spesifik saat tab dibuka
          if (tabId === 'reviews') loadReviews();
          if (tabId === 'orders') loadOrders();
          if (tabId === 'users') loadUsers();
        });
      });

      // --- ADMIN AUTH CHECK ---

      auth.onAuthStateChanged((user) => {
        const authStatus = document.getElementById('authStatus');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminTabs = document.getElementById('adminTabs');

        if (user) {
            isAdmin = ADMIN_UIDS.includes(user.uid);
            if (isAdmin) {
                authStatus.textContent = `Login sebagai Admin: ${user.email}`;
                logoutBtn.style.display = 'inline-block';
                adminTabs.style.display = 'flex';
                loadReviews(); // Muat ulasan saat pertama kali masuk ke Reviews tab
            } else {
                authStatus.textContent = "Akses Ditolak. Anda bukan Admin.";
                logoutBtn.style.display = 'inline-block';
                adminTabs.style.display = 'none';
                document.querySelector('.container').innerHTML = '<div class="card"><p style="text-align:center; color: var(--danger);">Anda tidak memiliki izin untuk mengakses halaman ini.</p></div>';
            }
        } else {
            isAdmin = false;
            authStatus.textContent = "Anda harus Login sebagai Admin.";
            logoutBtn.style.display = 'none';
            adminTabs.style.display = 'none';
            document.querySelector('.container').innerHTML = `
                <div class="card" style="text-align:center;">
                    <p style="margin-bottom: 15px;">Silakan login dengan akun Admin.</p>
                    <button class="btn" onclick="window.location.href='index.html'">Pergi ke Halaman Utama</button>
                </div>
            `;
        }
      });
      
      document.getElementById('logoutBtn').addEventListener('click', () => {
          auth.signOut().then(() => {
              window.alert('Berhasil Logout.');
              window.location.reload(); 
          }).catch(error => {
              window.alert('Gagal Logout: ' + error.message);
          });
      });
      
      // --- REVIEW MANAGEMENT FUNCTIONS (Review Tab) ---
      
      function loadReviews() {
        const list = document.getElementById('reviewsList');
        list.innerHTML = '<p style="text-align:center;">Memuat ulasan...</p>';
        
        db.collection('reviews').orderBy('timestamp','desc').get().then(snapshot=>{
            allReviews = snapshot.docs.map(doc=>({...doc.data(), id:doc.id, sentiment:(doc.data().rating>=4?'positif':doc.data().rating===3?'netral':'negatif')}));
            renderReviewsList();
        }).catch(e => {
            list.innerHTML = `<p style="text-align:center; color: var(--danger);">Gagal memuat ulasan. (${e.message})</p>`;
        });
      }

      function renderReviewsList(){
          const list = document.getElementById('reviewsList'); 
          list.innerHTML='';
          if(allReviews.length===0){ list.innerHTML='<p style="text-align:center;">Belum ada ulasan.</p>'; return; }
          
          allReviews.forEach(review=>{
              const card = document.createElement('div'); card.classList.add('review-card');
              const isPinned = review.pinned;
              const hasReply = review.reply && review.reply.text;
              
              const sentimentClass = review.sentiment === 'positif' ? 'tag-positif' : (review.sentiment === 'netral' ? 'tag-netral' : 'tag-danger');

              card.innerHTML=`
                <div class="review-header">
                  <span>${escapeHtml(review.reviewerName||'Anonim')}</span>
                  ${renderStars(review.rating)}
                </div>
                <div class="review-body">${escapeHtml(review.reviewText)}</div>
                ${hasReply ? `<div style="margin-top: 5px; font-style: italic;">Balasan: ${escapeHtml(review.reply.text).substring(0, 50)}...</div>` : ''}
                <div class="review-footer">
                    <span class="sentiment-tag ${sentimentClass}">${review.sentiment.toUpperCase()}</span>
                    <div class="admin-controls">
                        <button class="edit-reply-btn" onclick="openReplyModal('${review.id}', '${escapeHtml(review.reviewerName||'Anonim')}', '${escapeHtml(review.reply?.text || '')}')">
                            ${hasReply ? 'Edit Balasan' : 'Balas'}
                        </button>
                        <button class="${isPinned ? 'unpin-btn' : 'pin-btn'}" style="background-color: ${isPinned ? 'var(--gray)' : 'var(--secondary)'};" onclick="togglePin('${review.id}', ${!isPinned})">
                            ${isPinned ? 'Unpin' : 'üìå Pin'}
                        </button>
                        <button class="btn-danger" style="margin-left: 10px;" onclick="deleteReview('${review.id}')">Hapus</button>
                    </div>
                </div>
              `;
              list.appendChild(card);
          });
      }

      function togglePin(reviewId, isPinned) {
          db.collection('reviews').doc(reviewId).update({
              pinned: isPinned
          })
          .then(() => {
              window.alert(`Ulasan berhasil di-${isPinned ? 'pin' : 'unpin'}!`);
              loadReviews(); 
          })
          .catch(error => {
              window.alert('Gagal mengubah status pin: ' + error.message, true);
          });
      }

      function deleteReview(reviewId) {
          if (!confirm("Apakah Anda yakin ingin menghapus ulasan ini secara permanen?")) return; // Ganti dengan modal konfirmasi jika mau
          
          db.collection('reviews').doc(reviewId).delete()
          .then(() => {
              window.alert('Ulasan berhasil dihapus.');
              loadReviews();
          })
          .catch(error => {
              window.alert('Gagal menghapus ulasan: ' + error.message, true);
          });
      }

      // --- ADMIN REPLY MODAL FUNCTIONS ---
      
      function openReplyModal(reviewId, reviewerName, existingText) {
          currentReplyReviewId = reviewId;
          document.getElementById('replyReviewerName').textContent = reviewerName;
          document.getElementById('replyTextarea').value = existingText || '';
          document.getElementById('replyModal').style.display = 'flex';
          document.body.style.overflow = 'hidden';
      }
      
      function closeReplyModal() {
          document.getElementById('replyModal').style.display = 'none';
          document.body.style.overflow = 'auto';
          currentReplyReviewId = null;
      }
      
      document.getElementById('sendReplyBtn').addEventListener('click', sendReply);

      function sendReply() {
          const replyText = document.getElementById('replyTextarea').value.trim();
          if (replyText.length < 5) {
              window.alert('Balasan minimal 5 karakter.');
              return;
          }

          const user = auth.currentUser;

          db.collection('users').doc(user.uid).get().then(doc => {
              // Ambil nama admin dari koleksi users
              const adminName = doc.exists && doc.data().name ? doc.data().name : (user.displayName || 'Admin Sejuk Teknik');
              
              const updateData = {
                  reply: {
                      text: replyText,
                      adminName: adminName,
                      adminUid: user.uid,
                      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                      likes: [],
                      dislikes: []
                  }
              };

              return db.collection('reviews').doc(currentReplyReviewId).update(updateData);
          })
          .then(() => {
              closeReplyModal();
              window.alert('Balasan admin berhasil dikirim/diubah!');
              loadReviews(); 
          })
          .catch(error => {
              console.error('Error sending reply:', error);
              window.alert('Gagal mengirim balasan: ' + error.message, true);
          });
      }

      // --- NOTIFICATION MANAGEMENT (Notif Tab) ---

      // Event listener untuk saran judul
      document.getElementById('notifTitleSelect').addEventListener('change', function() {
          const select = this;
          const input = document.getElementById('notifTitle');
          if (select.value !== 'CUSTOM') {
              input.value = select.value;
          }
          input.focus();
      });

      // 1. User Search Logic
      document.getElementById('userSearch').addEventListener('input', debounce(() => {
        const query = document.getElementById('userSearch').value.toLowerCase().trim();
        const resultsContainer = document.getElementById('userSearchResults');
        resultsContainer.style.display = 'none';
        resultsContainer.innerHTML = '';
        
        // Cek mode Broadcast
        if (query === 'all' || query === 'All' || query === 'ALL') {
            targetUser = { uid: 'ALL_BROADCAST', name: 'SEMUA PENGGUNA', isAll: true };
            document.getElementById('selectedUserName').textContent = 'SEMUA PENGGUNA';
            document.getElementById('selectedUserUID').textContent = '(BROADCAST MODE)';
            document.getElementById('selectedUser').style.display = 'block';
            resultsContainer.innerHTML = '<p style="padding: 10px; font-weight: 600;">Mode BROADCAST dipilih. Notifikasi akan dikirim ke semua user terdaftar.</p>';
            resultsContainer.style.display = 'block';
            return;
        } else {
            targetUser = { uid: null, name: null, isAll: false };
            document.getElementById('selectedUser').style.display = 'none';
        }
        
        // Reset target user jika kotak pencarian kurang dari 3
        if (query.length < 3) {
            resultsContainer.innerHTML = '<p style="padding: 10px;">Ketik minimal 3 huruf.</p>';
            return;
        }
        
        resultsContainer.innerHTML = '<p style="padding: 10px; color: var(--primary);">Mencari...</p>';
        resultsContainer.style.display = 'block';


        // --- GABUNGKAN PENCARIAN NAMA DAN EMAIL ---
        const searchPromises = [
          db.collection('users').where('name', '>=', query).where('name', '<=', query + '\uf8ff').limit(10).get(),
          db.collection('users').where('email', '>=', query).where('email', '<=', query + '\uf8ff').limit(10).get()
        ];

        Promise.all(searchPromises)
          .then(results => {
            const nameSnapshot = results[0];
            const emailSnapshot = results[1];
            const combinedDocs = {};

            nameSnapshot.docs.forEach(doc => combinedDocs[doc.id] = { id: doc.id, ...doc.data() });
            emailSnapshot.docs.forEach(doc => combinedDocs[doc.id] = { id: doc.id, ...doc.data() });

            const users = Object.values(combinedDocs);
            
            resultsContainer.innerHTML = '';

            if (users.length === 0) {
                resultsContainer.innerHTML = '<p style="padding: 10px;">User tidak ditemukan.</p>';
                return;
            }

            users.forEach(user => {
                const item = document.createElement('div');
                item.classList.add('user-list-item');
                item.setAttribute('data-uid', user.id);
                const displayName = escapeHtml(user.name || user.email.split('@')[0]);
                item.setAttribute('data-name', displayName); 
                
                item.innerHTML = `
                  <strong>${displayName}</strong> 
                  <span style="font-size: 0.9em; color: var(--gray);">${escapeHtml(user.email)}</span> 
                  <span style="font-size: 0.7em; color: var(--gray); display: block;">UID: ${user.id.substring(0, 8)}...</span>
                `;
                
                item.addEventListener('click', selectUser);
                resultsContainer.appendChild(item);
            });
          })
          .catch(e => {
            resultsContainer.innerHTML = `<p style="padding: 10px; color: var(--danger);">Gagal mencari user: ${e.message}</p>`;
          });
      }, 500)); 

      function debounce(func, delay) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
      }
      
      function selectUser(e) {
          const selectedItem = e.target.closest('.user-list-item');
          if (!selectedItem) return;

          document.querySelectorAll('.user-list-item').forEach(item => item.classList.remove('selected'));
          selectedItem.classList.add('selected');

          targetUser.uid = selectedItem.getAttribute('data-uid');
          targetUser.name = selectedItem.getAttribute('data-name');
          targetUser.isAll = false;
          
          document.getElementById('selectedUserName').textContent = targetUser.name;
          document.getElementById('selectedUserUID').textContent = targetUser.uid;
          document.getElementById('selectedUser').style.display = 'block';
          document.getElementById('userSearchResults').style.display = 'none';
          document.getElementById('userSearch').value = targetUser.name; 
      }
      
      // 2. Kirim Notifikasi Logic
      document.getElementById('notificationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const sendNotifBtn = document.getElementById('sendNotifBtn');
        
        if (!targetUser.uid) {
            window.alert('Pilih pengguna tujuan terlebih dahulu.');
            return;
        }

        const title = document.getElementById('notifTitle').value.trim();
        const content = document.getElementById('notifContent').value.trim();
        const coinReward = parseInt(document.getElementById('coinReward').value) || 0;
        
        if (title.length < 3) {
            window.alert('Judul minimal 3 karakter.');
            return;
        }
        if (content.length < 5) {
            window.alert('Isi Pesan minimal 5 karakter.');
            return;
        }
        
        sendNotifBtn.disabled = true;
        sendNotifBtn.textContent = 'Mengirim...';
        
        // LOGIKA KIRIM NOTIFIKASI
        if (targetUser.isAll) {
            // MODE BROADCAST
            db.collection('users').get().then(snapshot => {
                const batch = db.batch();
                let sentCount = 0;
                
                snapshot.forEach(userDoc => {
                    const notificationData = {
                        userId: userDoc.id, // UID setiap user
                        title: title,
                        content: content,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false,
                        claimed: false,
                        coinReward: coinReward
                    };
                    batch.set(db.collection('notifications').doc(), notificationData);
                    sentCount++;
                });

                return batch.commit().then(() => sentCount);
            })
            .then((sentCount) => {
                window.alert(`SUCCESS: Notifikasi berhasil dikirim ke ${sentCount} pengguna.`);
                // Reset UI
                document.getElementById('notificationForm').reset();
                targetUser = { uid: null, name: null, isAll: false };
                document.getElementById('selectedUser').style.display = 'none';
                document.getElementById('userSearch').value = ''; 
                sendNotifBtn.textContent = 'Kirim Notifikasi';
                sendNotifBtn.disabled = false;
            })
            .catch(error => {
                window.alert('Gagal mengirim notifikasi BROADCAST: ' + error.message, true);
                sendNotifBtn.textContent = 'Kirim Notifikasi';
                sendNotifBtn.disabled = false;
            });

        } else {
            // MODE INDIVIDUAL
            const notificationData = {
                userId: targetUser.uid,
                title: title,
                content: content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false,
                claimed: false,
                coinReward: coinReward
            };
            
            db.collection('notifications').add(notificationData)
            .then(() => {
                window.alert(`Notifikasi berhasil dikirim ke ${targetUser.name}. Hadiah: ${coinReward} SJCoin.`);
                
                // Reset UI
                document.getElementById('notificationForm').reset();
                targetUser = { uid: null, name: null, isAll: false };
                document.getElementById('selectedUser').style.display = 'none';
                document.getElementById('userSearch').value = ''; 
                sendNotifBtn.textContent = 'Kirim Notifikasi';
                sendNotifBtn.disabled = false;
            })
            .catch(error => {
                window.alert('Gagal mengirim notifikasi: ' + error.message, true);
                sendNotifBtn.textContent = 'Kirim Notifikasi';
                sendNotifBtn.disabled = false;
            });
        }
      });


      // --- ORDER MANAGEMENT (Orders Tab) ---
      
      function loadOrders() {
          const list = document.getElementById('ordersList');
          list.innerHTML = '<p>Memuat daftar pesanan...</p>';
          
          db.collection('orders').orderBy('timestamp', 'desc').limit(50).get()
          .then(snapshot => {
              if (snapshot.empty) {
                  list.innerHTML = '<p>Tidak ada pesanan aktif.</p>';
                  return;
              }
              
              let tableHtml = `
                  <table class="data-table">
                  <thead>
                      <tr>
                          <th>ID Pesanan</th>
                          <th>User</th>
                          <th>Layanan</th>
                          <th>Status</th>
                          <th>Waktu</th>
                          <th>Aksi</th>
                      </tr>
                  </thead>
                  <tbody>
              `;
              
              snapshot.forEach(doc => {
                  const order = doc.data();
                  const orderId = doc.id;
                  const date = order.timestamp ? (order.timestamp.toDate ? order.timestamp.toDate() : new Date(order.timestamp.seconds * 1000)) : new Date();
                  const formattedTime = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' });
                  
                  tableHtml += `
                      <tr>
                          <td>${orderId.substring(0, 6)}...</td>
                          <td>${order.userName || order.userId.substring(0, 6)}...</td>
                          <td>${order.serviceType || 'N/A'}</td>
                          <td><span style="color: ${order.status === 'Selesai' ? 'var(--success)' : (order.status === 'Baru' ? 'var(--secondary)' : 'var(--primary)')}; font-weight: 600;">${order.status || 'Baru'}</span></td>
                          <td>${formattedTime}</td>
                          <td>
                              <button class="btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="viewOrder('${orderId}')">Detail</button>
                              <button class="btn-danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="deleteOrder('${orderId}')">Hapus</button>
                          </td>
                      </tr>
                  `;
              });
              
              list.innerHTML = tableHtml + '</tbody></table>';
          })
          .catch(e => {
              list.innerHTML = `<p style="color: var(--danger);">Gagal memuat pesanan. (${e.message})</p>`;
          });
      }
      
      // Dummy functions for Orders tab (perlu implementasi nyata)
      function viewOrder(orderId) {
          window.alert(`Menampilkan detail untuk Order ID: ${orderId}. Implementasi detail penuh belum tersedia.`);
      }
      
      function deleteOrder(orderId) {
          if (!confirm("Yakin ingin menghapus pesanan ini?")) return;
          
          db.collection('orders').doc(orderId).delete()
          .then(() => {
              window.alert('Pesanan berhasil dihapus.');
              loadOrders();
          })
          .catch(e => {
              window.alert('Gagal menghapus pesanan: ' + e.message, true);
          });
      }

      // --- USER LIST MANAGEMENT (Users Tab) ---

      function loadUsers() {
        const list = document.getElementById('usersList');
        list.innerHTML = '<p>Memuat daftar pengguna...</p>';

        db.collection('users').orderBy('createdAt', 'desc').limit(100).get()
        .then(snapshot => {
            if (snapshot.empty) {
                list.innerHTML = '<p>Tidak ada pengguna terdaftar.</p>';
                return;
            }

            let tableHtml = `
                  <table class="data-table">
                  <thead>
                      <tr>
                          <th>Nama</th>
                          <th>Email</th>
                          <th>SJCoin</th>
                          <th>Bergabung</th>
                          <th>Aksi</th>
                      </tr>
                  </thead>
                  <tbody>
              `;

            snapshot.forEach(doc => {
                const user = doc.data();
                const userId = doc.id;
                const date = user.createdAt ? (user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt.seconds * 1000)) : new Date();
                const formattedDate = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
                
                tableHtml += `
                    <tr>
                        <td>${escapeHtml(user.name || 'N/A')}</td>
                        <td>${escapeHtml(user.email || 'N/A')}</td>
                        <td><span style="color: var(--coin); font-weight: 600;">${user.sjcoin || 0}</span></td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="viewUserDetail('${userId}')">Detail</button>
                        </td>
                    </tr>
                `;
            });

            list.innerHTML = tableHtml + '</tbody></table>';
        })
        .catch(e => {
            list.innerHTML = `<p style="color: var(--danger);">Gagal memuat daftar pengguna. (${e.message})</p>`;
        });
      }

      function viewUserDetail(userId) {
          db.collection('users').doc(userId).get()
          .then(doc => {
              if (!doc.exists) {
                  window.alert('Detail pengguna tidak ditemukan.', true);
                  return;
              }
              const user = doc.data();
              const date = user.createdAt ? (user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt.seconds * 1000)) : new Date();
              const formattedDate = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });

              document.getElementById('userDetailTitle').textContent = `Detail Pengguna: ${user.name || user.email}`;
              document.getElementById('detailName').textContent = user.name || 'Belum diisi';
              document.getElementById('detailEmail').textContent = user.email || 'N/A';
              document.getElementById('detailAddress').textContent = user.address || 'Belum diisi';
              document.getElementById('detailPhone').textContent = user.phone || 'Belum diisi';
              document.getElementById('detailSJCoin').textContent = user.sjcoin || 0;
              document.getElementById('detailJoined').textContent = formattedDate;
              document.getElementById('detailUID').textContent = userId;
              
              // Set atribut untuk fungsi delete
              document.getElementById('userDetailModal').setAttribute('data-target-uid', userId);

              openUserDetailModal();
          })
          .catch(e => {
              window.alert('Gagal mengambil detail pengguna: ' + e.message, true);
          });
      }
      
      function openUserDetailModal() {
          document.getElementById('userDetailModal').style.display = 'flex';
          document.body.style.overflow = 'hidden';
      }

      function closeUserDetailModal() {
          document.getElementById('userDetailModal').style.display = 'none';
          document.body.style.overflow = 'auto';
      }

      function deleteUser() {
          const userId = document.getElementById('userDetailModal').getAttribute('data-target-uid');
          if (!userId) return;
          
          if (!confirm(`Yakin ingin MENGHAPUS PERMANEN pengguna ini: ${userId}? (Semua data akan hilang!)`)) return;
          
          // 1. Delete Firestore User Data
          db.collection('users').doc(userId).delete()
          .then(() => {
              // 2. Delete Firebase Auth User (Ini membutuhkan Cloud Function atau dilakukan di Firebase Admin SDK)
              // Karena ini di client-side, kita hanya bisa menghapus data Firestore.
              window.alert(`Data pengguna ${userId.substring(0, 8)}... berhasil dihapus dari Firestore. **PENTING:** Hapus juga akunnya dari Firebase Authentication Console!`);
              closeUserDetailModal();
              loadUsers();
          })
          .catch(e => {
              window.alert('Gagal menghapus data pengguna: ' + e.message, true);
          });
      }
      
    </script>
  </body>
</html>
