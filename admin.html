<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel — Sejuk Teknik AC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; background:#f9fafb; color:#1f2937; }
    .sidebar { width: 250px; background:#1e3a8a; color:white; height:100vh; position:fixed; top:0; left:0; display:flex; flex-direction:column; }
    .sidebar h2 { font-size:1.5rem; font-weight:bold; text-align:center; margin-top:1.2rem; }
    .sidebar a { padding:12px 16px; display:block; color:white; text-decoration:none; }
    .sidebar a:hover { background:#374151; }
    .main { margin-left:250px; padding:20px; }
    .card { background:white; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.05); padding:16px; margin-bottom:16px; }
    .btn { background:#2563eb; color:white; padding:6px 10px; border-radius:6px; cursor:pointer; border:none; }
    .btn:hover { background:#1d4ed8; }
    .input { border:1px solid #d1d5db; border-radius:6px; padding:6px; width:100%; margin-bottom:8px; }
    #notifModal { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:50; }
    #notifCard { background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="#" id="menuUsers">👥 Data User</a>
    <a href="#" id="menuOrders">📦 Pesanan</a>
    <a href="#" id="menuNotif">🔔 Kirim Notif</a>
    <a href="#" id="logoutAdmin">🚪 Logout</a>
  </div>

  <!-- Main -->
  <div class="main">
    <h1 class="text-2xl font-bold mb-4">Dashboard Admin</h1>
    <div id="content"></div>
  </div>

  <!-- Modal kirim notif -->
  <div id="notifModal">
    <div id="notifCard">
      <h2 class="font-bold text-lg mb-2">Kirim Notifikasi</h2>
      <label>Email / UID (kosongkan untuk semua):</label>
      <input type="text" id="targetInput" class="input" placeholder="user@email.com atau UID user">
      <label>Judul:</label>
      <input type="text" id="titleInput" class="input" placeholder="Judul notifikasi">
      <label>Isi Pesan:</label>
      <textarea id="bodyInput" class="input" placeholder="Isi pesan..."></textarea>
      <label>Jumlah SJcoin (opsional):</label>
      <input type="number" id="coinInput" class="input" placeholder="misal: 50">
      <div class="flex justify-end gap-2 mt-3">
        <button id="sendNotifBtn" class="btn">Kirim</button>
        <button id="cancelNotifBtn" class="btn bg-gray-400 hover:bg-gray-500">Batal</button>
      </div>
    </div>
  </div>

  <script type="module">
    // 🔹 Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { 
      getFirestore, collection, getDocs, getDoc, doc, addDoc, updateDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // 🔹 Firebase Config kamu
    const firebaseConfig = {
      apiKey: "AIzaSyDtLHSz7-KU97ALJTQvLRQTG5yj7brcsvc",
      authDomain: "sejuk-teknik.firebaseapp.com",
      projectId: "sejuk-teknik",
      storageBucket: "sejuk-teknik.firebasestorage.app",
      messagingSenderId: "733860478343",
      appId: "1:733860478343:web:172838a08e702d129ae722",
      measurementId: "G-EDJ6Y6J7GC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const content = document.getElementById('content');
    const notifModal = document.getElementById('notifModal');

    let currentAdmin = null;

    // 🔐 Cek login dan izin admin
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Kamu harus login sebagai admin!");
        window.location.href = "login.html";
        return;
      }
      const adminRef = doc(db, "admins", user.uid);
      const adminSnap = await getDoc(adminRef);
      if (!adminSnap.exists()) {
        alert("Akses ditolak! Kamu bukan admin.");
        window.location.href = "index.html";
        return;
      }
      currentAdmin = user;
      loadUsers(); // tampilkan user pertama kali
    });

    // 🚪 Logout
    document.getElementById("logoutAdmin").onclick = async () => {
      if (!confirm("Yakin ingin keluar dari admin panel?")) return;
      await signOut(auth);
      window.location.href = "index.html";
    };

    // 🧭 Menu event
    document.getElementById("menuUsers").onclick = loadUsers;
    document.getElementById("menuOrders").onclick = loadOrders;
    document.getElementById("menuNotif").onclick = () => notifModal.style.display = "flex";
    document.getElementById("cancelNotifBtn").onclick = () => notifModal.style.display = "none";

    // 🔔 Kirim notifikasi
    document.getElementById("sendNotifBtn").onclick = async () => {
      const target = document.getElementById("targetInput").value.trim() || "all";
      const title = document.getElementById("titleInput").value.trim();
      const body = document.getElementById("bodyInput").value.trim();
      const coin = parseInt(document.getElementById("coinInput").value.trim() || "0");

      if (!title || !body) return alert("Lengkapi judul & isi pesan!");

      await addDoc(collection(db, "notifications"), {
        target: target, // "all" untuk semua user, atau UID/email tertentu
        title: title,
        body: body,
        actions: coin > 0 ? ["claim", "ok", "delete"] : ["ok", "delete"],
        createdAt: serverTimestamp(),
        meta: coin > 0 ? { amount: coin } : {},
        sender: currentAdmin.email
      });

      alert("✅ Notifikasi berhasil dikirim!");
      notifModal.style.display = "none";
      document.getElementById("titleInput").value = "";
      document.getElementById("bodyInput").value = "";
      document.getElementById("coinInput").value = "";
    };

    // 👥 Tampilkan data user
    async function loadUsers() {
      content.innerHTML = "<h2 class='text-xl font-bold mb-3'>Data User</h2>";
      const usersRef = collection(db, "users");
      const snap = await getDocs(usersRef);
      if (snap.empty) {
        content.innerHTML += "<p>Belum ada user terdaftar.</p>";
        return;
      }
      snap.forEach((docSnap) => {
        const u = docSnap.data();
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3 class='font-bold text-lg'>${u.name || "(Tanpa Nama)"} — ${u.email}</h3>
          <p class='text-sm text-gray-600'>📱 ${u.phone || "-"}<br>🏠 ${u.address || "-"}<br>🕒 ${u.createdAt ? new Date(u.createdAt.seconds*1000).toLocaleString() : "-"}</p>
          <p>💰 SJcoin: <b>${u.coins || 0}</b></p>
          <div class='mt-2 flex gap-2'>
            <button class='btn viewUserBtn' data-id='${docSnap.id}'>Detail</button>
            <button class='btn bg-green-600 sendNotifBtn' data-id='${docSnap.id}'>Kirim Notif</button>
          </div>
        `;
        content.appendChild(card);
      });

      // Tombol detail user
      document.querySelectorAll(".viewUserBtn").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.id;
          const docSnap = await getDoc(doc(db,"users",id));
          const d = docSnap.data();
          alert(`
Nama: ${d.name || "-"}
Email: ${d.email}
Telepon: ${d.phone || "-"}
Alamat: ${d.address || "-"}
SJcoin: ${d.coins || 0}
Dibuat: ${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : "-"}
`);
        };
      });

      // Tombol kirim notif per user
      document.querySelectorAll(".sendNotifBtn").forEach(btn=>{
        btn.onclick = ()=>{
          document.getElementById("targetInput").value = btn.dataset.id;
          notifModal.style.display = "flex";
        };
      });
    }

    // 📦 Tampilkan pesanan
    async function loadOrders(){
      content.innerHTML = "<h2 class='text-xl font-bold mb-3'>Pesanan User</h2>";
      const orderRef = collection(db, "orders");
      const snap = await getDocs(orderRef);
      if (snap.empty) {
        content.innerHTML += "<p>Belum ada pesanan.</p>";
        return;
      }
      snap.forEach((docSnap)=>{
        const o = docSnap.data();
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <h3 class='font-semibold'>${o.service || "Layanan Tidak Diketahui"}</h3>
          <p>User: ${o.userEmail || "-"}<br>Tanggal: ${o.createdAt ? new Date(o.createdAt.seconds*1000).toLocaleString() : "-"}</p>
          <p>Status: <b>${o.status || "Pending"}</b></p>
        `;
        content.appendChild(div);
      });
    }

  </script>
</body>
</html>
