<!DOCTYPE html>
<html lang="id">
<head>
    <!-- [Bagian head yang sama seperti sebelumnya] -->
    <style>
        /* [CSS yang sama seperti sebelumnya] */
        
        /* Tambahan untuk skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-card {
            height: 120px;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--white);
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <!-- [Bagian HTML yang sama seperti sebelumnya] -->

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDEXAMPLEEXAMPLEEXAMPLE",
            authDomain: "sejukteknik-ac.firebaseapp.com",
            projectId: "sejukteknik-ac",
            storageBucket: "sejukteknik-ac.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456EXAMPLE"
        };

        // Inisialisasi Firebase dengan pengecekan
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            
            // Enable persistence untuk cache offline
            firebase.firestore().enablePersistence()
                .catch((err) => {
                    console.error("Firebase persistence error:", err);
                });
        }
        const db = firebase.firestore();

        // Variabel global
        let selectedRating = 0;
        let lastVisibleDoc = null;
        const batchSize = 5; // Mengurangi batch size untuk load lebih cepat
        let isLoading = false;
        let allReviewsLoaded = false;

        // Fungsi untuk menampilkan skeleton loading
        function showSkeletonLoading(count) {
            const reviewsList = document.getElementById('reviews-list');
            reviewsList.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-card';
                skeleton.innerHTML = `
                    <div class="skeleton" style="width: 40%; height: 20px; margin-bottom: 10px;"></div>
                    <div class="skeleton" style="width: 30%; height: 15px; margin-bottom: 15px;"></div>
                    <div class="skeleton" style="width: 20%; height: 15px; margin-bottom: 15px;"></div>
                    <div class="skeleton" style="width: 100%; height: 20px; margin-bottom: 5px;"></div>
                    <div class="skeleton" style="width: 90%; height: 20px;"></div>
                `;
                reviewsList.appendChild(skeleton);
            }
        }

        // [Fungsi initRatingStars, formatDate, validateForm, generateDisplayName, getIPAddress yang sama seperti sebelumnya]

        // Fungsi untuk reset reviews
        function resetReviews() {
            lastVisibleDoc = null;
            allReviewsLoaded = false;
            showSkeletonLoading(3); // Menampilkan skeleton loading saat reset
        }

        // Optimasi fungsi loadReviews
        async function loadReviews() {
            if (isLoading || allReviewsLoaded) return;
            
            isLoading = true;
            const sortBy = document.getElementById('review-sort').value;
            
            // Tampilkan skeleton loading hanya untuk load pertama
            if (lastVisibleDoc === null) {
                showSkeletonLoading(3);
            }
            
            try {
                let query = db.collection('reviews')
                            .where('approved', '==', true)
                            .limit(batchSize);
                
                // Optimasi: Gunakan indeks Firestore untuk query yang berbeda
                switch(sortBy) {
                    case 'newest':
                        query = query.orderBy('date', 'desc');
                        break;
                    case 'oldest':
                        query = query.orderBy('date', 'asc');
                        break;
                    case 'highest':
                        query = query.orderBy('rating', 'desc').orderBy('date', 'desc');
                        break;
                    case 'lowest':
                        query = query.orderBy('rating', 'asc').orderBy('date', 'desc');
                        break;
                }
                
                if (lastVisibleDoc) {
                    query = query.startAfter(lastVisibleDoc);
                }
                
                // Gunakan cache pertama, lalu update dengan data server
                const options = { source: 'cache' };
                let querySnapshot = await query.get(options);
                
                // Jika tidak ada data di cache, ambil dari server
                if (querySnapshot.empty) {
                    querySnapshot = await query.get({ source: 'server' });
                }
                
                const reviewsList = document.getElementById('reviews-list');
                
                if (querySnapshot.empty) {
                    if (lastVisibleDoc === null) {
                        reviewsList.innerHTML = `
                            <div class="no-reviews">
                                <i class="fas fa-comment-alt" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <p>Belum ada ulasan yang ditampilkan</p>
                            </div>
                        `;
                    }
                    allReviewsLoaded = true;
                    return;
                }
                
                // Hapus skeleton loading jika ada
                if (lastVisibleDoc === null) {
                    reviewsList.innerHTML = '';
                }
                
                lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                
                // Gunakan DocumentFragment untuk performa rendering yang lebih baik
                const fragment = document.createDocumentFragment();
                
                querySnapshot.forEach((doc) => {
                    const review = doc.data();
                    const dateString = formatDate(review.date?.toDate());
                    
                    const reviewCard = document.createElement('div');
                    reviewCard.className = 'review-card';
                    reviewCard.innerHTML = `
                        <div class="review-header">
                            <span class="review-name">${review.displayName || review.fullName?.charAt(0) + '***'}</span>
                            <span class="review-date">${dateString}</span>
                        </div>
                        ${review.service ? `<span class="review-service">${review.service}</span>` : ''}
                        <div class="review-rating">
                            ${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}
                            <span style="color: var(--gray); font-size: 0.8em; margin-left: 5px;">(${review.rating}/5)</span>
                        </div>
                        <div class="review-content">
                            ${review.review}
                        </div>
                    `;
                    
                    fragment.appendChild(reviewCard);
                });
                
                reviewsList.appendChild(fragment);
                
                allReviewsLoaded = querySnapshot.size < batchSize;
                
            } catch (error) {
                console.error('Error loading reviews:', error);
                
                // Fallback: Coba load dari cache jika error dari server
                if (error.code === 'unavailable') {
                    console.log('Trying to load from cache...');
                    await loadReviewsFromCache();
                } else {
                    alert('Terjadi kesalahan saat memuat ulasan.');
                }
            } finally {
                document.getElementById('loading-spinner').style.display = 'none';
                isLoading = false;
            }
        }

        // Fallback function untuk load dari cache saja
        async function loadReviewsFromCache() {
            try {
                const sortBy = document.getElementById('review-sort').value;
                let query = db.collection('reviews')
                            .where('approved', '==', true)
                            .limit(batchSize);
                
                switch(sortBy) {
                    case 'newest':
                        query = query.orderBy('date', 'desc');
                        break;
                    case 'oldest':
                        query = query.orderBy('date', 'asc');
                        break;
                    case 'highest':
                        query = query.orderBy('rating', 'desc').orderBy('date', 'desc');
                        break;
                    case 'lowest':
                        query = query.orderBy('rating', 'asc').orderBy('date', 'desc');
                        break;
                }
                
                if (lastVisibleDoc) {
                    query = query.startAfter(lastVisibleDoc);
                }
                
                const querySnapshot = await query.get({ source: 'cache' });
                const reviewsList = document.getElementById('reviews-list');
                
                if (querySnapshot.empty) {
                    if (lastVisibleDoc === null) {
                        reviewsList.innerHTML = `
                            <div class="no-reviews">
                                <i class="fas fa-comment-alt" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <p>Tidak dapat memuat ulasan. Silakan cek koneksi internet Anda.</p>
                            </div>
                        `;
                    }
                    allReviewsLoaded = true;
                    return;
                }
                
                if (lastVisibleDoc === null) {
                    reviewsList.innerHTML = '';
                }
                
                lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                
                const fragment = document.createDocumentFragment();
                
                querySnapshot.forEach((doc) => {
                    const review = doc.data();
                    const dateString = formatDate(review.date?.toDate());
                    
                    const reviewCard = document.createElement('div');
                    reviewCard.className = 'review-card';
                    reviewCard.innerHTML = `
                        <div class="review-header">
                            <span class="review-name">${review.displayName || review.fullName?.charAt(0) + '***'}</span>
                            <span class="review-date">${dateString}</span>
                        </div>
                        ${review.service ? `<span class="review-service">${review.service}</span>` : ''}
                        <div class="review-rating">
                            ${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}
                            <span style="color: var(--gray); font-size: 0.8em; margin-left: 5px;">(${review.rating}/5)</span>
                        </div>
                        <div class="review-content">
                            ${review.review}
                        </div>
                    `;
                    
                    fragment.appendChild(reviewCard);
                });
                
                reviewsList.appendChild(fragment);
                
                allReviewsLoaded = querySnapshot.size < batchSize;
                
            } catch (error) {
                console.error('Error loading from cache:', error);
                alert('Tidak dapat memuat ulasan. Silakan cek koneksi internet Anda.');
            }
        }

        // [Fungsi setupInfiniteScroll dan submitFeedback yang sama seperti sebelumnya]

        // Inisialisasi saat DOM siap
        document.addEventListener('DOMContentLoaded', function() {
            initRatingStars();
            
            document.getElementById('submit-btn').addEventListener('click', submitFeedback);
            
            document.getElementById('review-sort').addEventListener('change', function() {
                resetReviews();
                loadReviews();
            });
            
            setupInfiniteScroll();
            
            // Load data awal
            loadReviews();
        });
    </script>
</body>
</html>
