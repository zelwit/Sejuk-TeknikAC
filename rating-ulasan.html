<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rating & Ulasan | Sejuk Teknik AC</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<style>
  :root {
    --primary: #0066cc;
    --primary-light: #e6f2ff;
    --dark: #2d3748;
    --light: #f8fafc;
    --gray: #718096;
    --white: #ffffff;
  }
  * {box-sizing:border-box; margin:0; padding:0;}
  body {font-family:sans-serif; background:var(--light); color:var(--dark);}
  .btn {padding:0.5rem 1rem; border:none; border-radius:50px; cursor:pointer; background:var(--primary); color:#fff;}
  .review-card {background:#fff; padding:1rem; border-radius:10px; margin-bottom:1rem; position:relative;}
  .review-header {display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;}
  .review-stars i {color:#ffc107;}
  .review-footer {display:flex; justify-content:space-between; font-size:0.85rem; margin-top:0.5rem; gap:0.5rem; flex-wrap:wrap;}
  .sentiment-tag {padding:3px 8px; border-radius:20px; color:#fff; font-weight:500;}
  .tag-positif{background:#4caf50;}
  .tag-netral{background:#ff9800;}
  .tag-negatif{background:#f44336;}
  .admin-controls button{margin-left:5px; cursor:pointer; border:none; background:transparent; font-weight:600;}
  
  /* Modal Styles */
  .modal-overlay {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000;}
  .modal {background:#fff; padding:1.5rem; border-radius:12px; width:90%; max-width:400px; position:relative;}
  .modal h3 {margin-bottom:1rem; color:var(--primary);}
  .modal textarea {width:100%; padding:0.5rem; border-radius:8px; border:1px solid #ddd; margin-bottom:1rem;}
  .modal .close-btn {position:absolute; top:10px; right:10px; cursor:pointer; font-weight:bold; border:none; background:transparent; font-size:1.2rem;}
</style>
</head>
<body>

<section class="content" style="max-width:800px;margin:2rem auto;">
  <div id="reviewsList">
    <p style="text-align:center;">Memuat ulasan...</p>
  </div>
</section>

<!-- Modal for admin reply -->
<div class="modal-overlay" id="replyModal">
  <div class="modal">
    <button class="close-btn" onclick="closeReplyModal()">√ó</button>
    <h3 id="modalTitle">Boss mau balesin apa untuk %%USERNAME%%?</h3>
    <textarea id="replyText" rows="5" placeholder="Tulis balasan..."></textarea>
    <button class="btn" onclick="saveReply()">Kirim Balasan</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDtLHSz7-KU97ALJTQvLRQTG5yj7brcsvc",
  authDomain: "sejuk-teknik.firebaseapp.com",
  projectId: "sejuk-teknik",
  storageBucket: "sejuk-teknik.appspot.com",
  messagingSenderId: "733860478343",
  appId: "1:733860478343:web:172838a08e702d129ae722"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_UIDS = ['f3M49osGvtcGbEWf9UTdJe1AG013', 'JTVwtBsdt3PaaYeyICd8PJm3lJu2'];

let allReviews = [];
let currentReplyId = null;

function escapeHtml(text){return text?.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')||'';}

function renderStars(rating){
  let html=''; for(let i=1;i<=5;i++){html+=`<i class="${i<=rating?'fas':'far'} fa-star"></i>`;} return `<div class="review-stars">${html}</div>`;
}

function renderReviews(){
  const list = document.getElementById('reviewsList'); list.innerHTML='';
  if(allReviews.length===0){ list.innerHTML='<p style="text-align:center;">Belum ada ulasan.</p>'; return; }
  allReviews.forEach(review=>{
    const card = document.createElement('div'); card.classList.add('review-card');
    card.innerHTML=`
      <div class="review-header">
        <span>${escapeHtml(review.reviewerName||'Anonim')}</span>
        ${renderStars(review.rating)}
      </div>
      <div class="review-body">${escapeHtml(review.reviewText)}</div>
      <div class="review-footer">
        <span class="sentiment-tag tag-${review.sentiment}">${review.sentiment.toUpperCase()}</span>
        <div class="admin-controls" id="admin-area-${review.id}"></div>
      </div>
    `;
    list.appendChild(card);
    renderAdminControls(review);
  });
}

function renderAdminControls(review){
  const container = document.getElementById(`admin-area-${review.id}`);
  container.innerHTML='';
  auth.onAuthStateChanged(user=>{
    const isAdmin = user && ADMIN_UIDS.includes(user.uid);
    if(isAdmin){
      const btn = document.createElement('button'); btn.textContent=review.reply?'Edit Balasan':'Balas';
      btn.onclick=()=>openReplyModal(review.id,review.reviewerName,review.reply?.text||'');
      container.appendChild(btn);
    } else if(review.reply?.text){
      const likeBtn = document.createElement('button'); likeBtn.innerHTML='üëç <span id="like-'+review.id+'">'+(review.reply.likes?.length||0)+'</span>';
      likeBtn.onclick=()=>voteReply(review.id,'like');
      const dislikeBtn = document.createElement('button'); dislikeBtn.innerHTML='üëé <span id="dislike-'+review.id+'">'+(review.reply.dislikes?.length||0)+'</span>';
      dislikeBtn.onclick=()=>voteReply(review.id,'dislike');
      container.appendChild(likeBtn); container.appendChild(dislikeBtn);
    }
  });
}

function loadReviews(){
  db.collection('reviews').orderBy('timestamp','desc').get().then(snapshot=>{
    allReviews = snapshot.docs.map(doc=>({...doc.data(),id:doc.id,sentiment:(doc.data().rating>=4?'positif':doc.data().rating===3?'netral':'negatif')}));
    renderReviews();
  });
}

function openReplyModal(reviewId, username, existingText){
  currentReplyId=reviewId;
  document.getElementById('modalTitle').textContent=`Boss mau balesin apa untuk ${username}?`;
  document.getElementById('replyText').value=existingText||'';
  document.getElementById('replyModal').style.display='flex';
}

function closeReplyModal(){document.getElementById('replyModal').style.display='none';}

function saveReply(){
  const text=document.getElementById('replyText').value.trim();
  if(!text){alert('Isi balasan tidak boleh kosong'); return;}
  const user = auth.currentUser;
  if(!user || !ADMIN_UIDS.includes(user.uid)){alert('Hanya admin yang dapat membalas'); return;}
  db.collection('users').doc(user.uid).get().then(doc=>{
    const adminName = doc.exists && doc.data().name ? doc.data().name : user.displayName||'Admin';
    const replyObj = {adminUid:user.uid,adminName,text,timestamp:firebase.firestore.FieldValue.serverTimestamp(),likes:[],dislikes:[]};
    return db.collection('reviews').doc(currentReplyId).update({reply:replyObj});
  }).then(()=>{ closeReplyModal(); loadReviews(); }).catch(err=>{console.error(err); alert('Gagal menyimpan balasan'); });
}

function voteReply(reviewId,type){
  const user = auth.currentUser;
  if(!user){alert('Login terlebih dahulu'); return;}
  const ref = db.collection('reviews').doc(reviewId);
  db.runTransaction(transaction=>{
    return transaction.get(ref).then(doc=>{
      if(!doc.exists) throw 'Not found';
      const reply=doc.data().reply||{likes:[],dislikes:[]};
      const likes=new Set(reply.likes||[]); const dislikes=new Set(reply.dislikes||[]);
      if(type==='like'){likes.has(user.uid)?likes.delete(user.uid):(likes.add(user.uid),dislikes.delete(user.uid));}
      else{dislikes.has(user.uid)?dislikes.delete(user.uid):(dislikes.add(user.uid),likes.delete(user.uid));}
      const newReply={...reply,likes:Array.from(likes),dislikes:Array.from(dislikes)};
      transaction.update(ref,{reply:newReply});
      return {likes:newReply.likes.length,dislikes:newReply.dislikes.length};
    });
  }).then(({likes,dislikes})=>{
    document.getElementById('like-'+reviewId).textContent=likes;
    document.getElementById('dislike-'+reviewId).textContent=dislikes;
  }).catch(err=>console.error(err));
}

document.addEventListener('DOMContentLoaded',()=>{
  loadReviews();
});
</script>

</body>
</html>
